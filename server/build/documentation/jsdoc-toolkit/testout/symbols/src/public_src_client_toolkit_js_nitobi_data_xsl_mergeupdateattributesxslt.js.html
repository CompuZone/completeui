<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mergeUpdateAttributesXslxslt</span><span class="PUNC">=</span><span class="STRN">'&lt;?xml version="1.0" encoding="UTF-8"?> &lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"> &lt;xsl:output method="xml" version="1.0" encoding="UTF-8" indent="yes"/> &lt;x:t-x:n-xmlUpdate"> &lt;update>&lt;/update> &lt;/x:t-> &lt;x:t- match="@*|node()"> &lt;xsl:copy> &lt;x:at-x:s-@*|node()"/> &lt;/xsl:copy> &lt;/x:t-> &lt;x:t- match="//update//@*"> &lt;xsl:copy> &lt;x:at-x:s-node()|@*"/> &lt;/xsl:copy> &lt;/x:t-> &lt;!-- update the number of rows does not account for inserts! --> &lt;x:t- match="//metadata/@numrows"> &lt;xsl:attributex:n-{name(.)}">&lt;x:v-x:s-. - count((document(\'\')//data[@id=\'_default\']/e[@xac=\'d\']))" />&lt;/xsl:attribute> &lt;/x:t-> &lt;!-- merge the updated attributes for each row --> &lt;x:t- match="@*"> &lt;x:va-x:n-currentXI"x:s-../@xi"/> &lt;x:va-x:n-parentID"x:s-../../@id"/> &lt;x:va-x:n-parentXI"x:s-../../@xi"/> &lt;x:va-x:n-targetNode"x:s-(document(\'\')//'</span><span class="PUNC">+</span><span class="STRN">'*[@id=$parentID or @xi=$parentXI]/'</span><span class="PUNC">+</span><span class="STRN">'*[@xi=$currentXI and @xac=\'u\'])" /> &lt;x:c-> &lt;x:wh- test="($targetNode) and (name($targetNode)=name(..)) and (../@xi = $targetNode/@xi) and (name(../..) = name($targetNode/..))"> &lt;xsl:copy> &lt;x:at-x:s-node()|@*"/> &lt;/xsl:copy> &lt;x:at-x:s-$targetNode/@*" /> &lt;/x:wh-> &lt;x:o-> &lt;xsl:copy> &lt;x:at-x:s-node()|@*"/> &lt;/xsl:copy> &lt;/x:o-> &lt;/x:c-> &lt;/x:t-> &lt;!-- delete rows --> &lt;x:t- match="//root/'</span><span class="PUNC">+</span><span class="STRN">'*'</span><span class="PUNC">+</span><span class="STRN">'//node()"> &lt;x:va-x:n-currentXI"x:s-@xi"/> &lt;x:va-x:n-parentID"x:s-../@id"/> &lt;x:va-x:n-parentXI"x:s-../@xi"/> &lt;x:va-x:n-targetNode"x:s-(document(\'\')//'</span><span class="PUNC">+</span><span class="STRN">'*[@id=$parentID or @xi=$parentXI]/'</span><span class="PUNC">+</span><span class="STRN">'*[@xi=$currentXI and @xac=\'d\'])" /> &lt;x:c-> &lt;x:wh- test="($targetNode) and (name($targetNode/..)=name(..)) and (name() = name($targetNode))"> &lt;/x:wh-> &lt;x:o-> &lt;xsl:copy> &lt;x:at-x:s-node()|@*"/> &lt;/xsl:copy> &lt;/x:o-> &lt;/x:c-> &lt;/x:t-> &lt;/xsl:stylesheet>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>  2</span> </span><span class="NAME">mergeUpdateAttributesXslxslt</span><span class="PUNC">=</span><span class="NAME">mergeUpdateAttributesXslxslt.replace</span><span class="PUNC">(</span><span class="REGX">/x:c-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:choose'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:wh\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:when'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:o\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:otherwise'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:n\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">' name="'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:s\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">' select="'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:va\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:variable'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:v\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:value-of'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:ct\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:call-template'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:w\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:with-param'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:p\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:param'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:t\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:template'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/x\:at\-/g</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'xsl:apply-templates'</span><span class="PUNC">)</span></pre></body></html>