<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="NAME">nitobi.lang.defineNs</span><span class="PUNC">(</span><span class="STRN">'nitobi.data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>  2</span> 
<span class='line'>  3</span> </span><span class="COMM">/**
<span class='line'>  4</span>  * The DataTable represents a client side XML based datasource.
<span class='line'>  5</span>  * @param {Boolean} estimateRowCount If true, the datatable will actively try and find the last row of data.
<span class='line'>  6</span>  * @param {AssociativeArray} saveHandlerArgs Extra arguments that are attached to the saveHandler.
<span class='line'>  7</span>  * @param {AssociativeArray} getHandlerArgs Extra arguments that are attached to the getHandler.
<span class='line'>  8</span>  * @param {Boolean} autoKeyEnabled True if the datatable expects to parse the response and adjust keys 
<span class='line'>  9</span>  * assigned by the db server.
<span class='line'> 10</span>  */</span><span class="WHIT">
<span class='line'> 11</span> </span><span class="NAME">nitobi.data.DataTable</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">mode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">estimateRowCount</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">saveHandlerArgs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getHandlerArgs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">autoKeyEnabled</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 12</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 13</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">estimateRowCount</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 14</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 15</span> </span><span class="WHIT">		</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="KEYW">false</span><span class="PUNC">,</span><span class="STRN">"Table needs estimateRowCount param"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 16</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 17</span> </span><span class="WHIT">	</span><span class="NAME">this.estimateRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">estimateRowCount</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 18</span> </span><span class="WHIT">	</span><span class="NAME">this.version</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">3.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 19</span> </span><span class="WHIT">	</span><span class="NAME">this.uid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.base.getUid</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 20</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'> 21</span> 	 * 
<span class='line'> 22</span> 	 */</span><span class="WHIT">
<span class='line'> 23</span> </span><span class="WHIT">	</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">mode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">"caching"</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// Options: unbound | static | paging | caching</span><span class="WHIT">
<span class='line'> 24</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'> 25</span> </span><span class="WHIT">	</span><span class="NAME">this.setAutoKeyEnabled</span><span class="PUNC">(</span><span class="NAME">autoKeyEnabled</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 26</span> 
<span class='line'> 27</span> </span><span class="WHIT">	</span><span class="NAME">this.columns</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 28</span> </span><span class="WHIT">	</span><span class="NAME">this.keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 29</span> </span><span class="WHIT">	</span><span class="NAME">this.types</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 30</span> </span><span class="WHIT">	</span><span class="NAME">this.defaults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 31</span> 
<span class='line'> 32</span> </span><span class="WHIT">	</span><span class="NAME">this.columnsConfigured</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 33</span> </span><span class="WHIT">	</span><span class="NAME">this.pagingConfigured</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 34</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'> 35</span> </span><span class="WHIT">	</span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'_default'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 36</span> </span><span class="WHIT">	</span><span class="NAME">this.fieldMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 37</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">saveHandlerArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 38</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 39</span> </span><span class="WHIT">		</span><span class="NAME">this.saveHandlerArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">saveHandlerArgs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 40</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 41</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'> 42</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 43</span> </span><span class="WHIT">		</span><span class="NAME">this.saveHandlerArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 44</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 45</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">getHandlerArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 46</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 47</span> </span><span class="WHIT">		</span><span class="NAME">this.getHandlerArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getHandlerArgs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 48</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 49</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'> 50</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 51</span> </span><span class="WHIT">		</span><span class="NAME">this.getHandlerArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 52</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 53</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'> 54</span> </span><span class="WHIT">	</span><span class="NAME">this.setGetHandlerParameter</span><span class="PUNC">(</span><span class="STRN">"RequestType"</span><span class="PUNC">,</span><span class="STRN">"GET"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 55</span> </span><span class="WHIT">	</span><span class="NAME">this.setSaveHandlerParameter</span><span class="PUNC">(</span><span class="STRN">"RequestType"</span><span class="PUNC">,</span><span class="STRN">"SAVE"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 56</span> 
<span class='line'> 57</span> </span><span class="WHIT">	</span><span class="COMM">// We can do a batch insert by calling the beginBatchInsert() method. To finish the insert</span><span class="WHIT">
<span class='line'> 58</span> </span><span class="WHIT">	</span><span class="COMM">// the commitBatchInsert() method is called.</span><span class="WHIT">
<span class='line'> 59</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsert</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 60</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsertRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 61</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 62</span> 
<span class='line'> 63</span> </span><span class="NAME">nitobi.data.DataTable.DEFAULT_LOG</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'grid '</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsDecl</span><span class="PUNC">+</span><span class="STRN">'>&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasources id=\'id\'>&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource id="{id}">&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasourcestructure />&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data id="_default">&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data>&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource>&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasources>&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'grid>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 64</span> 
<span class='line'> 65</span> </span><span class="NAME">nitobi.data.DataTable.DEFAULT_DATA</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource '</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsDecl</span><span class="PUNC">+</span><span class="STRN">' id="{id}">&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasourcestructure FieldNames="{fields}" Keys="{keys}" types="{types}" defaults="{defaults}">&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasourcestructure>&lt;'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data id="{id}">&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data>&lt;/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource>'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 66</span> 
<span class='line'> 67</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'> 68</span> </span><span class="COMM">// CORE METHODS</span><span class="WHIT">
<span class='line'> 69</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'> 70</span> 
<span class='line'> 71</span> </span><span class="COMM">/**
<span class='line'> 72</span>  * This method initializes the DataTable and gets it ready for use.
<span class='line'> 73</span>  * @param {string} tableId
<span class='line'> 74</span>  * @param {object} getHandler The getHandler argument can be either a String 
<span class='line'> 75</span>  * that is the URL of a server based datasource or an XML DOM Document.
<span class='line'> 76</span>  * @param {string} postHandler The postHandler argument is the URL of a server
<span class='line'> 77</span>  * resource that can be used to save changes to data in the client side DataTable
<span class='line'> 78</span>  * on the server.
<span class='line'> 79</span>  * @param {int} start The index of the first record in the DataTable.
<span class='line'> 80</span>  * @param {int} pageSize The pageSize argument specifies the default number of records
<span class='line'> 81</span>  * to return from any given request for data using the get method.
<span class='line'> 82</span>  * @param {string} sort The sort argument specifies the default field to sort by.
<span class='line'> 83</span>  * @param {string} sortDir The sortDir argument specifies the default direction of 
<span class='line'> 84</span>  * the data sorting.
<span class='line'> 85</span>  * @param {Function} onGenerateKey The onGenerateKey arguments is a reference
<span class='line'> 86</span>  * @param {string} filter The filter criteria for the data
<span class='line'> 87</span>  * to a function that is used to create record keys when new records are created in the DataTable.
<span class='line'> 88</span>  */</span><span class="WHIT">
<span class='line'> 89</span> </span><span class="NAME">nitobi.data.DataTable.prototype.initialize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">tableId</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">postHandler</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sort</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sortDir</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">onGenerateKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">filter</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'> 90</span> </span><span class="WHIT">    </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 91</span> </span><span class="COMM">//	When sort is called on this thing we need to clear the cachemap and start getting data a new</span><span class="WHIT">
<span class='line'> 92</span> </span><span class="COMM">//	To return data from this what do we need to do???</span><span class="WHIT">
<span class='line'> 93</span> </span><span class="COMM">//	For the grid we just return the data based on xi values which are the record numbers ...</span><span class="WHIT">
<span class='line'> 94</span> </span><span class="COMM">//	We also need to consider the case where we dont page and just return it all!!!</span><span class="WHIT">
<span class='line'> 95</span> </span><span class="COMM">//	that is the case for the lookup data sources</span><span class="WHIT">
<span class='line'> 96</span> </span><span class="COMM">//	We need to grab the lookup data sources and merge those into the XSLT for displaying the data</span><span class="WHIT">
<span class='line'> 97</span> </span><span class="WHIT">		</span><span class="NAME">this.setGetHandlerParameter</span><span class="PUNC">(</span><span class="STRN">"TableId"</span><span class="PUNC">,</span><span class="NAME">tableId</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 98</span> </span><span class="WHIT">		</span><span class="NAME">this.setSaveHandlerParameter</span><span class="PUNC">(</span><span class="STRN">"TableId"</span><span class="PUNC">,</span><span class="NAME">tableId</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 99</span> </span><span class="WHIT">		</span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">tableId</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>100</span> 
<span class='line'>101</span> </span><span class="WHIT">		</span><span class="NAME">this.datastructure</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>102</span> </span><span class="WHIT">		</span><span class="NAME">this.descriptor</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.DataTableDescriptor</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.syncRowCount</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NAME">this.estimateRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>103</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>104</span> </span><span class="WHIT">		</span><span class="COMM">// Mode = unbound</span><span class="WHIT">
<span class='line'>105</span> </span><span class="WHIT">		</span><span class="COMM">// Mode = static</span><span class="WHIT">
<span class='line'>106</span> </span><span class="WHIT">		</span><span class="COMM">// Mode = paging</span><span class="WHIT">
<span class='line'>107</span> </span><span class="WHIT">		</span><span class="NAME">this.pageFirstRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// Note: applies only to mode=paging</span><span class="WHIT">
<span class='line'>108</span> </span><span class="WHIT">		</span><span class="NAME">this.pageRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// Note: applies only to mode=paging</span><span class="WHIT">
<span class='line'>109</span> </span><span class="WHIT">		</span><span class="NAME">this.pageSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>110</span> </span><span class="WHIT">		</span><span class="NAME">this.minPageSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">10</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>111</span> 
<span class='line'>112</span> </span><span class="WHIT">		</span><span class="COMM">// Mode = caching</span><span class="WHIT">
<span class='line'>113</span> </span><span class="WHIT">		</span><span class="NAME">this.requestCache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.collections.CacheMap</span><span class="PUNC">(</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>114</span> 
<span class='line'>115</span> </span><span class="WHIT">		</span><span class="COMM">// Mode = paging or caching</span><span class="WHIT">
<span class='line'>116</span> </span><span class="WHIT">		</span><span class="NAME">this.dataCache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.collections.CacheMap</span><span class="PUNC">(</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//Note: applies only to mode=caching</span><span class="WHIT">
<span class='line'>117</span> 
<span class='line'>118</span> </span><span class="WHIT">		</span><span class="NAME">this.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>119</span> 
<span class='line'>120</span> </span><span class="WHIT">		</span><span class="NAME">this.sortColumn</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sort</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>121</span> </span><span class="WHIT">		</span><span class="NAME">this.sortDir</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sortDir</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">'Asc'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>122</span> 
<span class='line'>123</span> </span><span class="WHIT">		</span><span class="NAME">this.filter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>124</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>125</span> </span><span class="WHIT">		</span><span class="NAME">this.onGenerateKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">onGenerateKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>126</span> 
<span class='line'>127</span> </span><span class="WHIT">		</span><span class="NAME">this.remoteRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//Note: applies to paging and caching modes</span><span class="WHIT">
<span class='line'>128</span> </span><span class="WHIT">		</span><span class="NAME">this.setRowCountKnown</span><span class="PUNC">(</span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">//Note: if row count is not known then external pageNext should increment startRow until less than pageSize rows are returned</span><span class="WHIT">
<span class='line'>129</span> 
<span class='line'>130</span> 
<span class='line'>131</span> </span><span class="WHIT">		</span><span class="COMM">//	Check if start and or pageSize are null ...</span><span class="WHIT">
<span class='line'>132</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>133</span> </span><span class="WHIT">			</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>134</span> 
<span class='line'>135</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"unbound"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>136</span> </span><span class="WHIT">			</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="PUNC">!=</span><span class="KEYW">null</span><span class="PUNC">&&</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="PUNC">)</span><span class="PUNC">!=</span><span class="STRN">"undefined"</span><span class="PUNC">,</span><span class="STRN">"getHandler is not specified for the nitobi.data.DataTable"</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">,</span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>137</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>138</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>139</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>140</span> </span><span class="WHIT">				</span><span class="NAME">this.ajaxCallbackPool</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.ajax.HttpRequestPool</span><span class="PUNC">(</span><span class="NAME">nitobi.ajax.HttpRequestPool_MAXCONNECTIONS</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>141</span> </span><span class="WHIT">				</span><span class="NAME">this.ajaxCallbackPool.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>142</span> </span><span class="WHIT">				</span><span class="NAME">this.setGetHandler</span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>143</span> </span><span class="WHIT">				</span><span class="NAME">this.setSaveHandler</span><span class="PUNC">(</span><span class="NAME">postHandler</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>144</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>145</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.ajax.HttpRequest</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>146</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.responseType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>147</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"string"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>149</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>150</span> </span><span class="WHIT">				</span><span class="COMM">// TODO: this is deprecated - call initializeColumns from outside and pass in the data ... </span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">				</span><span class="NAME">this.initializeXml</span><span class="PUNC">(</span><span class="NAME">getHandler</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>152</span> </span><span class="COMM">//				this.xmlDoc = getHandler;</span><span class="WHIT">
<span class='line'>153</span> </span><span class="COMM">//				ntbAssert(typeof(this.xmlDoc.xml)!="undefined","Valid XML required for new tabledatasource.",'',EBA_THROW);</span><span class="WHIT">
<span class='line'>154</span> </span><span class="WHIT">				</span><span class="COMM">//	parse out the various things like the fields etc ...</span><span class="WHIT">
<span class='line'>155</span> </span><span class="COMM">//				this.datastructure = this.xmlDoc.selectSingleNode('//'+nitobi.xml.nsPrefix+'datasource[@id=\'' + this.id + '\']/'+nitobi.xml.nsPrefix+'datasourcestructure');</span><span class="WHIT">
<span class='line'>156</span> </span><span class="COMM">//				this.makeFieldMap();</span><span class="WHIT">
<span class='line'>157</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>158</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>159</span> 
<span class='line'>160</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: Figure out how to remove paramters from XSLT's in IE then we can get rid of this...</span><span class="WHIT">
<span class='line'>161</span> </span><span class="WHIT">		</span><span class="NAME">this.sortXslProc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createXslProcessor</span><span class="PUNC">(</span><span class="NAME">nitobi.data.sortXslProc.stylesheet</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>162</span> 
<span class='line'>163</span> </span><span class="WHIT">		</span><span class="NAME">this.requestQueue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>164</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>165</span> </span><span class="WHIT">		</span><span class="COMM">/**
<span class='line'>166</span> 		 * Specifies if the requests to the server are synchronous or asynchronous by default.
<span class='line'>167</span> 		 */</span><span class="WHIT">
<span class='line'>168</span> </span><span class="WHIT">		</span><span class="NAME">this.async</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>169</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>170</span> 
<span class='line'>171</span> </span><span class="COMM">/**
<span class='line'>172</span>  * Set the onGenerateKey event handler.
<span class='line'>173</span>  * @param {String} Javascript code that is evaluated to retrieve the new key.
<span class='line'>174</span>  */</span><span class="WHIT">
<span class='line'>175</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setOnGenerateKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">onGenerateKey</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>176</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>177</span> </span><span class="WHIT">	</span><span class="NAME">this.onGenerateKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">onGenerateKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>178</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>179</span> 
<span class='line'>180</span> </span><span class="COMM">/**
<span class='line'>181</span>  * Returns the onGenerateKey event handler.
<span class='line'>182</span>  * @return String Javascript code that is evaluated to retrieve the new key.
<span class='line'>183</span>  */</span><span class="WHIT">
<span class='line'>184</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getOnGenerateKey</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>185</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>186</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.onGenerateKey</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>187</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>188</span> 
<span class='line'>189</span> 
<span class='line'>190</span> </span><span class="COMM">/**
<span class='line'>191</span>  * @private
<span class='line'>192</span>  */</span><span class="WHIT">
<span class='line'>193</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setAutoKeyEnabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">val</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>194</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>195</span> </span><span class="WHIT">	</span><span class="NAME">this.autoKeyEnabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">val</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>196</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>197</span> 
<span class='line'>198</span> </span><span class="COMM">/**
<span class='line'>199</span>  * @private
<span class='line'>200</span>  */</span><span class="WHIT">
<span class='line'>201</span> </span><span class="NAME">nitobi.data.DataTable.prototype.isAutoKeyEnabled</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>202</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>203</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.autoKeyEnabled</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>204</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>205</span> 
<span class='line'>206</span> 
<span class='line'>207</span> </span><span class="COMM">/**
<span class='line'>208</span>  * Initializes a DataTable based on the fields, keys, defaults and types arrays.
<span class='line'>209</span>  * @param {object} xml XML data from which the DataTable can be initialized.
<span class='line'>210</span>  */</span><span class="WHIT">
<span class='line'>211</span> </span><span class="NAME">nitobi.data.DataTable.prototype.initializeXml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">oXml</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>212</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>213</span> </span><span class="WHIT">	</span><span class="NAME">this.replaceData</span><span class="PUNC">(</span><span class="NAME">oXml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>214</span> 
<span class='line'>215</span> </span><span class="WHIT">	</span><span class="COMM">// in the case that the xml also has actual data in it (not just schema)</span><span class="WHIT">
<span class='line'>216</span> </span><span class="WHIT">	</span><span class="COMM">// then we need to setup the data</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rows</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>218</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">rows</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>220</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: Fix this to string then loading the xml crap</span><span class="WHIT">
<span class='line'>221</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.xml</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>222</span> </span><span class="COMM">//		if (this.mode != "paging")</span><span class="WHIT">
<span class='line'>223</span> </span><span class="COMM">//		{</span><span class="WHIT">
<span class='line'>224</span> </span><span class="WHIT">			</span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sortXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>225</span> </span><span class="COMM">//		}</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">		</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>227</span> 
<span class='line'>228</span> </span><span class="WHIT">		</span><span class="NAME">this.dataCache.insert</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rows</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>229</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'local'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>230</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>231</span> </span><span class="WHIT">			</span><span class="NAME">this.setRowCountKnown</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>232</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>233</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>234</span> 
<span class='line'>235</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: this should be integrated back into the descriptor</span><span class="WHIT">
<span class='line'>236</span> </span><span class="WHIT">	</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">rows</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>237</span> </span><span class="WHIT">	</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"DataInitalized"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>238</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>239</span> 
<span class='line'>240</span> </span><span class="COMM">/**
<span class='line'>241</span>  * Loads valid XML data from either a string or an XML document in the Nitobi Grid format. The data must have 
<span class='line'>242</span>  * &lt;ntb:grid&gt; and &lt;ntb:datasources&gt; tags.
<span class='line'>243</span>  * @param {String | XmlDocument} oXml Either a string or XML document of valid XML.
<span class='line'>244</span>  * @private
<span class='line'>245</span>  */</span><span class="WHIT">
<span class='line'>246</span> </span><span class="NAME">nitobi.data.DataTable.prototype.initializeXmlData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">oXml</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>247</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>248</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sXml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">oXml</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>249</span> </span><span class="WHIT">	</span><span class="COMM">// accept either an xml doc or a string of xml</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">oXml</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"object"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>251</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>252</span> </span><span class="WHIT">		</span><span class="NAME">sXml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">oXml.xml</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>253</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>254</span> 
<span class='line'>255</span> </span><span class="WHIT">	</span><span class="COMM">// load up the xml</span><span class="WHIT">
<span class='line'>256</span> </span><span class="WHIT">	</span><span class="NAME">sXml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sXml.replace</span><span class="PUNC">(</span><span class="REGX">/fieldnames=/g</span><span class="PUNC">,</span><span class="STRN">"FieldNames="</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/keys=/g</span><span class="PUNC">,</span><span class="STRN">"Keys="</span><span class="PUNC">)</span><span class="COMM">//.replace(/defaults=/g,"Defaults=").replace(/types=/g,"Types=");</span><span class="WHIT">
<span class='line'>257</span> 
<span class='line'>258</span> </span><span class="WHIT">	</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sXml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>259</span> 
<span class='line'>260</span> </span><span class="WHIT">	</span><span class="NAME">this.datastructure</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasourcestructure'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>261</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>262</span> 
<span class='line'>263</span> </span><span class="NAME">nitobi.data.DataTable.prototype.replaceData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">oXml</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>264</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>265</span> </span><span class="WHIT">	</span><span class="NAME">this.initializeXmlData</span><span class="PUNC">(</span><span class="NAME">oXml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>266</span> 
<span class='line'>267</span> </span><span class="WHIT">	</span><span class="COMM">// get the datasroucestructure information to initialize the column </span><span class="WHIT">
<span class='line'>268</span> </span><span class="WHIT">	</span><span class="COMM">// array definitions</span><span class="WHIT">
<span class='line'>269</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.datastructure.getAttribute</span><span class="PUNC">(</span><span class="STRN">"FieldNames"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>270</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.datastructure.getAttribute</span><span class="PUNC">(</span><span class="STRN">"Keys"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>271</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">defaults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.datastructure.getAttribute</span><span class="PUNC">(</span><span class="STRN">"Defaults"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>272</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">types</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.datastructure.getAttribute</span><span class="PUNC">(</span><span class="STRN">"Types"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>273</span> 
<span class='line'>274</span> </span><span class="WHIT">	</span><span class="COMM">// initialize the columns with that data specified in the xml schema.</span><span class="WHIT">
<span class='line'>275</span> </span><span class="WHIT">	</span><span class="NAME">this.initializeColumns</span><span class="PUNC">(</span><span class="NAME">fields</span><span class="PUNC">,</span><span class="NAME">keys</span><span class="PUNC">,</span><span class="NAME">types</span><span class="PUNC">,</span><span class="NAME">defaults</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>276</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>277</span> 
<span class='line'>278</span> </span><span class="COMM">/**
<span class='line'>279</span>  * Initializes the DataTable xmlDoc from the default structure with the 
<span class='line'>280</span>  * defined fields from the this.columns property. Columns and keys are generally
<span class='line'>281</span>  * first defined by calling initializeColumns.
<span class='line'>282</span>  */</span><span class="WHIT">
<span class='line'>283</span> </span><span class="NAME">nitobi.data.DataTable.prototype.initializeSchema</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>284</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>285</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.columns.join</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>286</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.keys.join</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>287</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">defaults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.defaults.join</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>288</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">types</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.types.join</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>289</span> 
<span class='line'>290</span> </span><span class="WHIT">	</span><span class="NAME">this.dataCache.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>291</span> 
<span class='line'>292</span> </span><span class="WHIT">	</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.DataTable.DEFAULT_DATA.replace</span><span class="PUNC">(</span><span class="REGX">/\{id\}/g</span><span class="PUNC">,</span><span class="NAME">this.id</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{fields\}/g</span><span class="PUNC">,</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{keys\}/g</span><span class="PUNC">,</span><span class="NAME">keys</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{defaults\}/g</span><span class="PUNC">,</span><span class="NAME">defaults</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{types\}/g</span><span class="PUNC">,</span><span class="NAME">types</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>293</span> 
<span class='line'>294</span> </span><span class="WHIT">	</span><span class="NAME">this.datastructure</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasourcestructure'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>295</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>296</span> 
<span class='line'>297</span> </span><span class="COMM">/**
<span class='line'>298</span>  * Defines the columns structure for the table including keys, datatypes and initial default values when rows are inserted.
<span class='line'>299</span>  * @param {string} fields A pipe ("|") separated list of fields that are in the Datasource
<span class='line'>300</span>  * @param {string} keys A pipe ("|") separated list of the key fields in the Datasource
<span class='line'>301</span>  * @param {string} types A pipe ("|") separated list of the field types in the Datasource
<span class='line'>302</span>  * @param {string} default A pipe ("|") separated list of the default values for each of the fields in the Datasource
<span class='line'>303</span>  */</span><span class="WHIT">
<span class='line'>304</span> </span><span class="NAME">nitobi.data.DataTable.prototype.initializeColumns</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">fields</span><span class="PUNC">,</span><span class="NAME">keys</span><span class="PUNC">,</span><span class="NAME">types</span><span class="PUNC">,</span><span class="NAME">defaults</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>305</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>306</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>307</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>308</span> </span><span class="WHIT">		</span><span class="COMM">// check if we are actually changing the columns</span><span class="WHIT">
<span class='line'>309</span> </span><span class="WHIT">		</span><span class="COMM">// if not then just return as there is no need</span><span class="WHIT">
<span class='line'>310</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sColumns</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.columns.join</span><span class="PUNC">(</span><span class="STRN">'|'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>311</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">sColumns</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>312</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>313</span> </span><span class="WHIT">		</span><span class="NAME">this.columns</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fields.split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>314</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>315</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>316</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>317</span> </span><span class="WHIT">		</span><span class="NAME">this.keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">keys.split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>318</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>319</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">types</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>320</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>321</span> </span><span class="WHIT">		</span><span class="NAME">this.types</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">types.split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>322</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>323</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">defaults</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>324</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>325</span> </span><span class="WHIT">		</span><span class="NAME">this.defaults</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">defaults.split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>326</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>327</span> </span><span class="WHIT">	</span><span class="COMM">// if the xmldoc is null then we have not been called from inisitalizeXml ...</span><span class="WHIT">
<span class='line'>328</span> </span><span class="WHIT">	</span><span class="COMM">// this seems a bit weird</span><span class="WHIT">
<span class='line'>329</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.xmlDoc.documentElement</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>330</span> </span><span class="WHIT">		</span><span class="COMM">// initializeSchema will use the internal columns etc arrays as defined just above.</span><span class="WHIT">
<span class='line'>331</span> </span><span class="WHIT">		</span><span class="NAME">this.initializeSchema</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>332</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>333</span> </span><span class="WHIT">	</span><span class="COMM">// not really any need to set the datastructure pointer as it should alreay be set.</span><span class="WHIT">
<span class='line'>334</span> </span><span class="WHIT">	</span><span class="NAME">this.datastructure</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasourcestructure'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>335</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.datastructure</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>336</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ds.setAttribute</span><span class="PUNC">(</span><span class="STRN">"FieldNames"</span><span class="PUNC">,</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>337</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">keys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ds.setAttribute</span><span class="PUNC">(</span><span class="STRN">"Keys"</span><span class="PUNC">,</span><span class="NAME">keys</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>338</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">defaults</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ds.setAttribute</span><span class="PUNC">(</span><span class="STRN">"Defaults"</span><span class="PUNC">,</span><span class="NAME">defaults</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>339</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">types</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">ds.setAttribute</span><span class="PUNC">(</span><span class="STRN">"Types"</span><span class="PUNC">,</span><span class="NAME">types</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>340</span> 
<span class='line'>341</span> </span><span class="COMM">//	this.flush();</span><span class="WHIT">
<span class='line'>342</span> </span><span class="COMM">//	this.initializeXml(xml);</span><span class="WHIT">
<span class='line'>343</span> </span><span class="WHIT">	</span><span class="NAME">this.makeFieldMap</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>344</span> </span><span class="WHIT">	</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"ColumnsInitialized"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>345</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>346</span> </span><span class="COMM">/**
<span class='line'>347</span>  * Creates a prototype xml node for use in insert operations
<span class='line'>348</span>  * @param {array} values An array of values used as the new node. Optional.  If this is
<span class='line'>349</span>  * not specified, the defaults are used instead.
<span class='line'>350</span>  * @returns {XMLNode} Returns the XMLNode that can be used to insert data into the DataTable.
<span class='line'>351</span>  */</span><span class="WHIT">
<span class='line'>352</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getTemplateNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">values</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>353</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>354</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">templateNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>355</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">values</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>356</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>357</span> </span><span class="WHIT">		</span><span class="NAME">values</span><span class="PUNC">=</span><span class="NAME">this.defaults</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>358</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>359</span> 
<span class='line'>360</span> </span><span class="WHIT">	</span><span class="NAME">templateNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createElement</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"e"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>361</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">this.columns.length</span><span class="PUNC">;</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>362</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keyAttribute</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">></span><span class="NUMB">25</span><span class="PUNC">?</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">/</span><span class="NUMB">26</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="NUMB">97</span><span class="PUNC">)</span><span class="PUNC">:</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="PUNC">(</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">%</span><span class="NUMB">26</span><span class="PUNC">+</span><span class="NUMB">97</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>363</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.defaults</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>364</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>365</span> </span><span class="WHIT">		    </span><span class="NAME">templateNode.setAttribute</span><span class="PUNC">(</span><span class="NAME">keyAttribute</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>366</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>367</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>368</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>369</span> </span><span class="WHIT">		    </span><span class="NAME">templateNode.setAttribute</span><span class="PUNC">(</span><span class="NAME">keyAttribute</span><span class="PUNC">,</span><span class="NAME">this.defaults</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>370</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>371</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>372</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">templateNode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>373</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>374</span> </span><span class="COMM">/**
<span class='line'>375</span>  * @private
<span class='line'>376</span>  */</span><span class="WHIT">
<span class='line'>377</span> </span><span class="NAME">nitobi.data.DataTable.prototype.commitProperties</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>378</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>379</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"unbound"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>380</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>381</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>382</span> </span><span class="COMM">/**
<span class='line'>383</span>  * Clear the data and data log.
<span class='line'>384</span>  * @public
<span class='line'>385</span> */</span><span class="WHIT">
<span class='line'>386</span> </span><span class="NAME">nitobi.data.DataTable.prototype.flush</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>387</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>388</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: This should be here but causes some unknowns </span><span class="WHIT">
<span class='line'>389</span> </span><span class="WHIT">	</span><span class="COMM">// regarding the refresh function.</span><span class="WHIT">
<span class='line'>390</span> </span><span class="WHIT">	</span><span class="COMM">//this.descriptor.reset();</span><span class="WHIT">
<span class='line'>391</span> </span><span class="WHIT">	</span><span class="NAME">this.flushCache</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>392</span> </span><span class="WHIT">	</span><span class="NAME">this.flushLog</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>393</span> 
<span class='line'>394</span> </span><span class="WHIT">	</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createXmlDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>395</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>396</span> 
<span class='line'>397</span> </span><span class="COMM">/**
<span class='line'>398</span>  * Clears the cache, flushes the log and clears the data.  Differs
<span class='line'>399</span>  * from {@link #flush} in that it will not reset the data to a blank
<span class='line'>400</span>  * XML document, but simply clear the data from the existing XML document.
<span class='line'>401</span>  * @private
<span class='line'>402</span>  */</span><span class="WHIT">
<span class='line'>403</span> </span><span class="NAME">nitobi.data.DataTable.prototype.clearData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>404</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>405</span> </span><span class="WHIT">	</span><span class="NAME">this.flushCache</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>406</span> </span><span class="WHIT">	</span><span class="NAME">this.flushLog</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>407</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>408</span> </span><span class="WHIT">   	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>409</span> </span><span class="WHIT">   		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentDataNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//ntb:data"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>410</span> </span><span class="WHIT">   		</span><span class="NAME">nitobi.xml.removeChildren</span><span class="PUNC">(</span><span class="NAME">parentDataNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>411</span> </span><span class="WHIT">   	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>412</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>413</span> 
<span class='line'>414</span> </span><span class="COMM">/**
<span class='line'>415</span>  * Clears out the data and request caches.
<span class='line'>416</span>  * @private
<span class='line'>417</span>  */</span><span class="WHIT">
<span class='line'>418</span> </span><span class="NAME">nitobi.data.DataTable.prototype.flushCache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>419</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>420</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"caching"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"paging"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>421</span> </span><span class="WHIT">		</span><span class="NAME">this.dataCache.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>422</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">!=</span><span class="STRN">"unbound"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>423</span> </span><span class="WHIT">		</span><span class="NAME">this.requestCache.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>424</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>425</span> 
<span class='line'>426</span> </span><span class="COMM">/**
<span class='line'>427</span>  * join
<span class='line'>428</span>  * @private
<span class='line'>429</span>  */</span><span class="WHIT">
<span class='line'>430</span> </span><span class="NAME">nitobi.data.DataTable.prototype.join</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">otherDataSource</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">field</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>431</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>432</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>433</span> </span><span class="COMM">/**
<span class='line'>434</span>  * merge - see mergeFromXml
<span class='line'>435</span>  * @private
<span class='line'>436</span>  */</span><span class="WHIT">
<span class='line'>437</span> </span><span class="NAME">nitobi.data.DataTable.prototype.merge</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>438</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>439</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>440</span> 
<span class='line'>441</span> </span><span class="COMM">/**
<span class='line'>442</span>  * Returns the data residing in the specified row at the specified column.
<span class='line'>443</span>  * @param {Number} index The row index.
<span class='line'>444</span>  * @param {String} columnName The name of the column.
<span class='line'>445</span>  */</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>446</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">columnName</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>447</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>448</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">r</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getRecord</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>449</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">columnName</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>450</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">a</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">r</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>451</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>452</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">r.getAttribute</span><span class="PUNC">(</span><span class="NAME">a.substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>453</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>454</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>455</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>456</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>457</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>458</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>459</span> </span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>460</span> </span><span class="COMM">/**
<span class='line'>461</span>  * Returns the requested record from the DataTable.
<span class='line'>462</span>  * @param {Number} index The index of the requested record in the DataTable.
<span class='line'>463</span>  * @returns {XmlElement} Returns the XML element from the DataTable.
<span class='line'>464</span>  */</span><span class="WHIT">
<span class='line'>465</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getRecord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>466</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>467</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasource[@id='"</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">"']/"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"data/"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e[@xi='"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"']"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>468</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">data.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>469</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>470</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>471</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>472</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>473</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>474</span> 
<span class='line'>475</span> </span><span class="COMM">/**
<span class='line'>476</span>  * Starts a batch insert. After calling beginBatchInsert no events will be fired due to insert 
<span class='line'>477</span>  * events until commitBatchInsert is called.
<span class='line'>478</span>  */</span><span class="WHIT">
<span class='line'>479</span> </span><span class="NAME">nitobi.data.DataTable.prototype.beginBatchInsert</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>480</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>481</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsert</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>482</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsertRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>483</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>484</span> </span><span class="COMM">/**
<span class='line'>485</span>  * Ends a batch insert. The RowInserted event will be fired if there were any rows inserted after 
<span class='line'>486</span>  * beginBatchInsert was called and before commitBatchInsert is called.
<span class='line'>487</span>  */</span><span class="WHIT">
<span class='line'>488</span> </span><span class="NAME">nitobi.data.DataTable.prototype.commitBatchInsert</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>489</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>490</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: this should change so that the createRecord method will not actually</span><span class="WHIT">
<span class='line'>491</span> </span><span class="WHIT">	</span><span class="COMM">// do the insert in batch mode but instead create a list of all the records to </span><span class="WHIT">
<span class='line'>492</span> </span><span class="WHIT">	</span><span class="COMM">// create and then use some xsl.</span><span class="WHIT">
<span class='line'>493</span> 
<span class='line'>494</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsert</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>495</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">insertedRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.batchInsertRowCount</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>496</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsertRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>497</span> 
<span class='line'>498</span> </span><span class="WHIT">	</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">this.remoteRowCount</span><span class="PUNC">+</span><span class="NAME">insertedRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>499</span> 
<span class='line'>500</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">insertedRowCount</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>501</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>502</span> </span><span class="WHIT">		</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowInserted"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">insertedRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>504</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>505</span> 
<span class='line'>506</span> </span><span class="COMM">/**
<span class='line'>507</span>  * Creates a new row record in the table
<span class='line'>508</span>  * @param {XMLNode} templateNode A prototype of the row record that contains the structure and defaults for the new row.
<span class='line'>509</span>  * @param {int} rowIndex Index of the row to insert after.
<span class='line'>510</span>  * @returns {XMLNode} Returns the newly inserted XMLNode.
<span class='line'>511</span>  */</span><span class="WHIT">
<span class='line'>512</span> </span><span class="NAME">nitobi.data.DataTable.prototype.createRecord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">templateNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rowIndex</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>513</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>514</span> </span><span class="WHIT">  	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rowIndex</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>515</span> </span><span class="WHIT">	</span><span class="NAME">this.adjustXi</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">xi</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>516</span> 
<span class='line'>517</span> </span><span class="COMM">//		var data = this.xmlDoc.selectSingleNode('//'+nitobi.xml.nsPrefix+'datasource[@id=\'_default\']/'+nitobi.xml.nsPrefix+'data');</span><span class="WHIT">
<span class='line'>518</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>519</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rowDataTemplate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">templateNode</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.getTemplateNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>520</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>521</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lastXid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.component.getUniqueId</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>522</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rowDataTemplate.cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>523</span> </span><span class="WHIT">	</span><span class="NAME">xNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xi</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>524</span> </span><span class="WHIT">	</span><span class="NAME">xNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastXid</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>525</span> </span><span class="WHIT">	</span><span class="NAME">xNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"i"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>526</span> 
<span class='line'>527</span> </span><span class="WHIT">	</span><span class="COMM">// If a key generation function is specified, add keys to the key fields in </span><span class="WHIT">
<span class='line'>528</span> </span><span class="WHIT">	</span><span class="COMM">// the grid and in the updategram</span><span class="WHIT">
<span class='line'>529</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.onGenerateKey</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>530</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>531</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keyCols</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasourcestructure"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"Keys"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>532</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>533</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">keyCols.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>534</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>535</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keyField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">keyCols</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>536</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keyValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xNode.getAttribute</span><span class="PUNC">(</span><span class="NAME">keyField</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>537</span> </span><span class="WHIT">			</span><span class="COMM">/*
<span class='line'>538</span> 			* I added undefined here, since this is the value that is passed
<span class='line'>539</span> 			* when the xk column isn't set.
<span class='line'>540</span> 			*/</span><span class="WHIT">
<span class='line'>541</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">keyValue</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">keyValue</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>542</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>543</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">xml</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>544</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>545</span> </span><span class="WHIT">					</span><span class="NAME">xml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">eval</span><span class="PUNC">(</span><span class="NAME">this.onGenerateKey</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">xml</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'string'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">xml</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'number'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>548</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>549</span> </span><span class="WHIT">					</span><span class="NAME">xNode.setAttribute</span><span class="PUNC">(</span><span class="NAME">keyField</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xml</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>550</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>551</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>552</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>553</span> </span><span class="WHIT">					</span><span class="KEYW">try</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>554</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>555</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ck1</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">%</span><span class="NUMB">26</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>556</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ck2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">j</span><span class="PUNC">/</span><span class="NUMB">26</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>557</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keyAttribute</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">ck2</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">?</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NUMB">96</span><span class="PUNC">+</span><span class="NAME">ck2</span><span class="PUNC">)</span><span class="PUNC">:</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NUMB">97</span><span class="PUNC">+</span><span class="NAME">ck1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>558</span> </span><span class="WHIT">						</span><span class="NAME">xNode.setAttribute</span><span class="PUNC">(</span><span class="NAME">keyField</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xml.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="NAME">keyAttribute</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>559</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>560</span> </span><span class="WHIT">					</span><span class="KEYW">catch</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>561</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>562</span> </span><span class="WHIT">						</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="KEYW">false</span><span class="PUNC">,</span><span class="STRN">"Key generation failed."</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">,</span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>563</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>564</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>565</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>566</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>567</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>568</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>569</span> </span><span class="WHIT">	</span><span class="NAME">data.appendChild</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">data.ownerDocument</span><span class="PUNC">,</span><span class="NAME">xNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>570</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>571</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>572</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>573</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xLogNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xNode.cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>574</span> </span><span class="WHIT">		</span><span class="NAME">xLogNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"i"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>575</span> </span><span class="WHIT">		</span><span class="NAME">xLogNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastXid</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>576</span> 
<span class='line'>577</span> </span><span class="WHIT">		</span><span class="NAME">this.logData.appendChild</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">this.logData.ownerDocument</span><span class="PUNC">,</span><span class="NAME">xLogNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>578</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>579</span> 
<span class='line'>580</span> </span><span class="WHIT">	</span><span class="NAME">this.dataCache.insertIntoRange</span><span class="PUNC">(</span><span class="NAME">rowIndex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>581</span> 
<span class='line'>582</span> </span><span class="WHIT">	</span><span class="NAME">this.batchInsertRowCount</span><span class="WHIT"> </span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>583</span> 
<span class='line'>584</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.batchInsert</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>585</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>586</span> </span><span class="WHIT">		</span><span class="COMM">// If we are not doing a batch insert then just call commitBatchInsert </span><span class="WHIT">
<span class='line'>587</span> </span><span class="WHIT">		</span><span class="COMM">// which will increment the row count and fire the rowinserted event</span><span class="WHIT">
<span class='line'>588</span> </span><span class="WHIT">		</span><span class="NAME">this.commitBatchInsert</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>589</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>590</span> 
<span class='line'>591</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>592</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>593</span> </span><span class="COMM">/**
<span class='line'>594</span>  * Updates a single column value for a single record in the table. If AutoSave is true then updates will automatically be sent to the server.
<span class='line'>595</span>  * @param {int} xi The index of the row to update.
<span class='line'>596</span>  * @param {string} field Name of the column to be updated.
<span class='line'>597</span>  * @param {string} value New value for the field.
<span class='line'>598</span>  */</span><span class="WHIT">
<span class='line'>599</span> </span><span class="NAME">nitobi.data.DataTable.prototype.updateRecord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">field</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>600</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>601</span> </span><span class="WHIT">	</span><span class="COMM">// todo refactor this into a new method or object</span><span class="WHIT">
<span class='line'>602</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">editedNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e[@xi=\''</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">xi</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'\']'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>603</span> 
<span class='line'>604</span> </span><span class="WHIT">    </span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">editedNode</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">'Could not find the specified node in the data source.\nTableDataSource: '</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\nRow: '</span><span class="PUNC">+</span><span class="NAME">xi</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">,</span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>605</span> </span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editedNode.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">"error - unknown xid"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>606</span> </span><span class="WHIT">    </span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="STRN">"error - unknown xid"</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">xid</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">'Could not find the specified node in the update log.\nTableDataSource: '</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\nRow: '</span><span class="PUNC">+</span><span class="NAME">xi</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">,</span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>607</span> 
<span class='line'>608</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: this delta only checks for if the delta exists based on the field </span><span class="WHIT">
<span class='line'>609</span> </span><span class="WHIT">	</span><span class="COMM">// argument being an ebaxml attribute name not a friendly name.</span><span class="WHIT">
<span class='line'>610</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">deltaExists</span><span class="WHIT"> 	</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editedNode.getAttribute</span><span class="PUNC">(</span><span class="NAME">field</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>611</span> 
<span class='line'>612</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">deltaExists</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>613</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>614</span> </span><span class="WHIT">		</span><span class="COMM">//no changes made</span><span class="WHIT">
<span class='line'>615</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>616</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>617</span> 
<span class='line'>618</span> </span><span class="WHIT">	</span><span class="COMM">// we found the row node that contains the updated cell	</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">	</span><span class="COMM">// What happens if the row is deleted?</span><span class="WHIT">
<span class='line'>620</span> 
<span class='line'>621</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oldValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>622</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mappedField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">field</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>623</span> </span><span class="WHIT">	</span><span class="COMM">//	Check if the field name provided actually exists on the node</span><span class="WHIT">
<span class='line'>624</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">editedNode.getAttribute</span><span class="PUNC">(</span><span class="NAME">field</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">field</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>625</span> </span><span class="WHIT">		</span><span class="NAME">mappedField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">field</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>626</span> 
<span class='line'>627</span> </span><span class="WHIT">	</span><span class="NAME">oldValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editedNode.getAttribute</span><span class="PUNC">(</span><span class="NAME">mappedField</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>628</span> </span><span class="WHIT">	</span><span class="NAME">editedNode.setAttribute</span><span class="PUNC">(</span><span class="NAME">mappedField</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>629</span> 
<span class='line'>630</span> </span><span class="WHIT">	</span><span class="COMM">// if null create the new row and set xac to i</span><span class="WHIT">
<span class='line'>631</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rowXacAttr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"u"</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// for updategram</span><span class="WHIT">
<span class='line'>632</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">columnXacAttr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"u"</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// for updategram</span><span class="WHIT">
<span class='line'>633</span> 
<span class='line'>634</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>635</span> 		we want the updategram to be created and assigned to this.log
<span class='line'>636</span> 		The following format will be used:
<span class='line'>637</span> 		&lt;root> &lt;data id="_default">
<span class='line'>638</span> 
<span class='line'>639</span> 				&lt;e a="Cat and dogs" xi="0" xac="u" />
<span class='line'>640</span> 		&lt;/data>
<span class='line'>641</span> 		&lt;gridmeta id="_defaultDataModel?" numcols="1" numrows="1">
<span class='line'>642</span> 		&lt;/gridmeta>
<span class='line'>643</span> 		&lt;/root>
<span class='line'>644</span> 	*/</span><span class="WHIT">
<span class='line'>645</span> </span><span class="WHIT">	</span><span class="COMM">// if null then we need to assign this.log to a new xml doc </span><span class="WHIT">
<span class='line'>646</span> 
<span class='line'>647</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">this.log</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>648</span> </span><span class="WHIT">		</span><span class="NAME">this.flushLog</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>649</span> 
<span class='line'>650</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">updatedNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">editedNode.cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>651</span> 
<span class='line'>652</span> </span><span class="WHIT">	</span><span class="NAME">updatedNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">,</span><span class="STRN">"u"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>653</span> 
<span class='line'>654</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: consider if we need to check for a delete before setting the xac attribute to update</span><span class="WHIT">
<span class='line'>655</span> 
<span class='line'>656</span> </span><span class="WHIT">	</span><span class="NAME">this.logData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>657</span> 
<span class='line'>658</span> </span><span class="WHIT">	</span><span class="COMM">// This will get the node in the DataTable log with the given xi - if it exists</span><span class="WHIT">
<span class='line'>659</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">logNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.logData.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'./'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e[@xid=\''</span><span class="PUNC">+</span><span class="NAME">xid</span><span class="PUNC">+</span><span class="STRN">'\']'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>660</span> 
<span class='line'>661</span> </span><span class="WHIT">	</span><span class="NAME">updatedNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">this.logData.ownerDocument</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">updatedNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>662</span> 
<span class='line'>663</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">logNode</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>664</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>665</span> </span><span class="WHIT">		</span><span class="COMM">// If there is not already a node in the log for this xi then append the cloned data node</span><span class="WHIT">
<span class='line'>666</span> </span><span class="WHIT">		</span><span class="NAME">updatedNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">this.logData.ownerDocument</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">updatedNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>667</span> </span><span class="WHIT">		</span><span class="NAME">this.logData.appendChild</span><span class="PUNC">(</span><span class="NAME">updatedNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>668</span> </span><span class="WHIT">		</span><span class="NAME">updatedNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">,</span><span class="NAME">xid</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>669</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>670</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>671</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>672</span> </span><span class="WHIT">		</span><span class="COMM">// keep the old xac value  This makes sure that "d" and "i" are not replaced by "u"</span><span class="WHIT">
<span class='line'>673</span> </span><span class="WHIT">		</span><span class="NAME">updatedNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">logNode.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>674</span> </span><span class="WHIT">		</span><span class="NAME">this.logData.replaceChild</span><span class="PUNC">(</span><span class="NAME">updatedNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">logNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>675</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>676</span> 
<span class='line'>677</span> </span><span class="WHIT">	</span><span class="COMM">//now update the value</span><span class="WHIT">
<span class='line'>678</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">this.AutoSave</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">// also need to check for metadata deltas && deltaExists)	</span><span class="WHIT">
<span class='line'>679</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>680</span> </span><span class="WHIT">		</span><span class="NAME">this.save</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>681</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>682</span> 
<span class='line'>683</span> </span><span class="WHIT">	</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowUpdated"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="STRN">"field"</span><span class="PUNC">:</span><span class="NAME">field</span><span class="PUNC">,</span><span class="STRN">"newValue"</span><span class="PUNC">:</span><span class="NAME">value</span><span class="PUNC">,</span><span class="STRN">"oldValue"</span><span class="PUNC">:</span><span class="NAME">oldValue</span><span class="PUNC">,</span><span class="STRN">"record"</span><span class="PUNC">:</span><span class="NAME">updatedNode</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>684</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>685</span> </span><span class="COMM">/**
<span class='line'>686</span>  * Deletes a single row from the table.
<span class='line'>687</span>  * @param index The index of the row to be deleted.
<span class='line'>688</span>  */</span><span class="WHIT">
<span class='line'>689</span> </span><span class="NAME">nitobi.data.DataTable.prototype.deleteRecord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>690</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>691</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>692</span> </span><span class="WHIT">	</span><span class="NAME">this.logData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>693</span> </span><span class="WHIT">	</span><span class="COMM">// Delete the XML Data node.</span><span class="WHIT">
<span class='line'>694</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"*[@xi = '"</span><span class="PUNC">+</span><span class="NAME">index</span><span class="PUNC">+</span><span class="STRN">"']"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>695</span> 
<span class='line'>696</span> </span><span class="WHIT">	</span><span class="NAME">this.removeRecordFromXml</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>697</span> 
<span class='line'>698</span> </span><span class="WHIT">	</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">this.remoteRowCount</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>699</span> 
<span class='line'>700</span> </span><span class="WHIT">	</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowDeleted"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>701</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>702</span> 
<span class='line'>703</span> </span><span class="COMM">/**
<span class='line'>704</span>  * 
<span class='line'>705</span>  * @param indices - sorted array of indices of records to delete
<span class='line'>706</span>  */</span><span class="WHIT">
<span class='line'>707</span> </span><span class="NAME">nitobi.data.DataTable.prototype.deleteRecordsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">indices</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>708</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>709</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>710</span> </span><span class="WHIT">	</span><span class="NAME">this.logData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>711</span> </span><span class="WHIT">	</span><span class="COMM">// Delete the XML Data node.</span><span class="WHIT">
<span class='line'>712</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>713</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>714</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>715</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">indices.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>716</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>717</span> </span><span class="WHIT">		</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">indices</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>718</span> </span><span class="WHIT">		</span><span class="NAME">xNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">data.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"*[@xi = '"</span><span class="PUNC">+</span><span class="NAME">index</span><span class="PUNC">+</span><span class="STRN">"']"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>719</span> </span><span class="WHIT">		</span><span class="NAME">this.removeRecordFromXml</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>720</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>721</span> 
<span class='line'>722</span> </span><span class="WHIT">	</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">this.remoteRowCount</span><span class="PUNC">-</span><span class="NAME">indices.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>723</span> 
<span class='line'>724</span> </span><span class="WHIT">	</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowDeleted"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>725</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>726</span> 
<span class='line'>727</span> </span><span class="COMM">/**
<span class='line'>728</span>  * Private - Refactored out to delete individual records, so it can be used for array
<span class='line'>729</span>  */</span><span class="WHIT">
<span class='line'>730</span> </span><span class="NAME">nitobi.data.DataTable.prototype.removeRecordFromXml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>731</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>732</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">xNode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>733</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>734</span> </span><span class="WHIT">		</span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="STRN">"Index out of bounds in delete."</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>735</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>736</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>737</span> </span><span class="WHIT">	</span><span class="COMM">// Check the updategram log to see if this cell is already in there.</span><span class="WHIT">
<span class='line'>738</span> </span><span class="WHIT">	</span><span class="COMM">// If it was an inserted record, delete the Insert log entry, otherwise make a note</span><span class="WHIT">
<span class='line'>739</span> </span><span class="WHIT">	</span><span class="COMM">// in the log that this record was deleted.</span><span class="WHIT">
<span class='line'>740</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xNode.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>741</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xDel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.logData.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"*[@xid='"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">xid</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"']"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>742</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sTag</span><span class="PUNC">=</span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>743</span> </span><span class="WHIT">	</span><span class="COMM">// refactor replaceChild could make this code cleaner</span><span class="WHIT">
<span class='line'>744</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">xDel</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>745</span> </span><span class="WHIT">		</span><span class="NAME">sTag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xDel.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">		</span><span class="NAME">this.logData.removeChild</span><span class="PUNC">(</span><span class="NAME">xDel</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>748</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">sTag</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"i"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>749</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xDelNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xNode.cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>750</span> </span><span class="WHIT">		</span><span class="NAME">xDelNode.setAttribute</span><span class="PUNC">(</span><span class="STRN">"xac"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"d"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>751</span> </span><span class="WHIT">		</span><span class="NAME">this.logData.appendChild</span><span class="PUNC">(</span><span class="NAME">xDelNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>752</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>753</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>754</span> </span><span class="WHIT">	</span><span class="NAME">data.removeChild</span><span class="PUNC">(</span><span class="NAME">xNode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>755</span> 
<span class='line'>756</span> </span><span class="WHIT">	</span><span class="NAME">this.adjustXi</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>757</span> 
<span class='line'>758</span> </span><span class="WHIT">	</span><span class="NAME">this.dataCache.removeFromRange</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>759</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>760</span> 
<span class='line'>761</span> </span><span class="COMM">/**
<span class='line'>762</span>  * Adjusts the XI's of all records after the specified record by some adjustment value.
<span class='line'>763</span>  * @param {Number} iStart The start index to increment / decrement XI values from.
<span class='line'>764</span>  * @param {Number} iAdjust The number by which to increment / decrement the XI values.
<span class='line'>765</span>  */</span><span class="WHIT">
<span class='line'>766</span> </span><span class="NAME">nitobi.data.DataTable.prototype.adjustXi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">iStart</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">iAdjust</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>767</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>768</span> </span><span class="WHIT">	</span><span class="NAME">nitobi.data.adjustXiXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"startingIndex"</span><span class="PUNC">,</span><span class="NAME">iStart</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>769</span> </span><span class="WHIT">	</span><span class="NAME">nitobi.data.adjustXiXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"adjustment"</span><span class="PUNC">,</span><span class="NAME">iAdjust</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">	</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.adjustXiXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>772</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>773</span> </span><span class="WHIT">		</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.adjustXiXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>774</span> </span><span class="WHIT">		</span><span class="NAME">this.logData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>775</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>776</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>777</span> 
<span class='line'>778</span> </span><span class="COMM">/**
<span class='line'>779</span>  * The URL to which get requests will be sent.
<span class='line'>780</span>   @param {string} val The URL.
<span class='line'>781</span>  */</span><span class="WHIT">
<span class='line'>782</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setGetHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">val</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>783</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">	</span><span class="NAME">this.getHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">val</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>785</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">this.getHandlerArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>786</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>787</span> </span><span class="WHIT">		</span><span class="NAME">this.setGetHandlerParameter</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="NAME">this.getHandlerArgs</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>788</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>789</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>790</span> 
<span class='line'>791</span> </span><span class="COMM">/**
<span class='line'>792</span>  * The URL to which get requests will be sent.
<span class='line'>793</span>   @return string The URL.
<span class='line'>794</span>  */</span><span class="WHIT">
<span class='line'>795</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getGetHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>796</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.getHandler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>798</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>799</span> 
<span class='line'>800</span> 
<span class='line'>801</span> </span><span class="COMM">/**
<span class='line'>802</span>  * The URL to which save requests will be sent.
<span class='line'>803</span>   @param {string} val The URL.
<span class='line'>804</span>  */</span><span class="WHIT">
<span class='line'>805</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setSaveHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">val</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>806</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>807</span> </span><span class="WHIT">	</span><span class="NAME">this.postHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">val</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>808</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">name</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="NAME">this.saveHandlerArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>809</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>810</span> </span><span class="WHIT">		</span><span class="NAME">this.setSaveHandlerParameter</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="NAME">this.saveHandlerArgs</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>811</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>812</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>813</span> 
<span class='line'>814</span> </span><span class="COMM">/**
<span class='line'>815</span>  * The URL to which save requests will be sent.
<span class='line'>816</span>   @return string The URL.
<span class='line'>817</span>  */</span><span class="WHIT">
<span class='line'>818</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getSaveHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>819</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>820</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.postHandler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>821</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>822</span> 
<span class='line'>823</span> 
<span class='line'>824</span> </span><span class="COMM">/**
<span class='line'>825</span>  * Commits the changes in the log back to the remote save handler. This method will generate 
<span class='line'>826</span>  * keys for inserted rows, convert the data format to match the old backend, send the data
<span class='line'>827</span>  * to the server asynchronously.
<span class='line'>828</span>  * @param {Function} callback The function to be called when data has been saved to the server.
<span class='line'>829</span>  * @param {string} beforeSaveEvent JavaScript code to be evaluated before proceeding with the save.
<span class='line'>830</span>  */</span><span class="WHIT">
<span class='line'>831</span> </span><span class="NAME">nitobi.data.DataTable.prototype.save</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">beforeSaveEvent</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>832</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>833</span> 
<span class='line'>834</span> </span><span class="WHIT">		</span><span class="COMM">//	Send the updates to the server now...</span><span class="WHIT">
<span class='line'>835</span> 
<span class='line'>836</span> </span><span class="WHIT">   		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>837</span> </span><span class="WHIT">  		</span><span class="COMM">// the updategram is retained but save operation is postponed.</span><span class="WHIT">
<span class='line'>838</span> </span><span class="WHIT">  		</span><span class="COMM">// This will means the client and server are now split brain</span><span class="WHIT">
<span class='line'>839</span> </span><span class="WHIT">		</span><span class="COMM">// </span><span class="WHIT">
<span class='line'>840</span> </span><span class="WHIT">  		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>841</span> </span><span class="WHIT">  		</span><span class="COMM">// It is best if a get from the server is done to ensure the</span><span class="WHIT">
<span class='line'>842</span> </span><span class="WHIT">  		</span><span class="COMM">// client grid is consistent</span><span class="WHIT">
<span class='line'>843</span> </span><span class="WHIT">  		</span><span class="WHIT">
<span class='line'>844</span> </span><span class="WHIT">  		</span><span class="COMM">//	TODO: Maybe this should be elsewehre???</span><span class="WHIT">
<span class='line'>845</span> 
<span class='line'>846</span> </span><span class="COMM">/*
<span class='line'>847</span> 		this.subscribe("BeforeSave",beforeSaveEvent); // this is wierd... passing in the function to call as a parameter
<span class='line'>848</span> 		if (!this.fire("BeforeSave")) {
<span class='line'>849</span> 			return;
<span class='line'>850</span> 		}
<span class='line'>851</span> */</span><span class="WHIT">
<span class='line'>852</span> 
<span class='line'>853</span> </span><span class="WHIT">		</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">this.postHandler</span><span class="PUNC">!=</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.postHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">,</span><span class="STRN">'A postHandler must be defined on the DataTable for saving to work.'</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">,</span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>854</span> 
<span class='line'>855</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">eval</span><span class="PUNC">(</span><span class="NAME">beforeSaveEvent</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">"true"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>856</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>857</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>858</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>859</span> 
<span class='line'>860</span> </span><span class="WHIT">		</span><span class="KEYW">try</span><span class="WHIT">
<span class='line'>861</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>862</span> 
<span class='line'>863</span> </span><span class="WHIT">			</span><span class="COMM">//	Check which version of the backend we are using ...</span><span class="WHIT">
<span class='line'>864</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.version</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">2.8</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>865</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>866</span> </span><span class="WHIT">				</span><span class="COMM">//	That means we are using the old backend ...</span><span class="WHIT">
<span class='line'>867</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasourcestructure"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"FieldNames"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>868</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">insertNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e[@xac = 'i']"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>869</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">insertNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>870</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>871</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">fields.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>872</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>873</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">insertNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">fields</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>874</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">currentValue</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>875</span> </span><span class="WHIT">						</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>876</span> </span><span class="WHIT">							</span><span class="NAME">insertNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">setAttribute</span><span class="PUNC">(</span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">fields</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>877</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>878</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>879</span> </span><span class="WHIT">					</span><span class="NAME">insertNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">setAttribute</span><span class="PUNC">(</span><span class="STRN">"xf"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.parentValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>880</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>881</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">updateNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e[@xac = 'u']"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>882</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">updateNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>883</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>884</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">fields.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>885</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>886</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">updateNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">fields</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>887</span> </span><span class="WHIT">						</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">currentValue</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>888</span> </span><span class="WHIT">						</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>889</span> </span><span class="WHIT">							</span><span class="NAME">updateNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">setAttribute</span><span class="PUNC">(</span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">fields</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>890</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>891</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>892</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>893</span> 
<span class='line'>894</span> </span><span class="WHIT">				</span><span class="NAME">nitobi.data.updategramTranslatorXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'xkField'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="STRN">'_xk'</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>895</span> </span><span class="WHIT">				</span><span class="NAME">nitobi.data.updategramTranslatorXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'fields'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fields.join</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\|_xk/</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>896</span> </span><span class="WHIT">				</span><span class="NAME">nitobi.data.updategramTranslatorXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"datasourceId"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>897</span> </span><span class="WHIT">				</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToXml</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.updategramTranslatorXslProc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>898</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>899</span> </span><span class="WHIT">			</span><span class="COMM">// After this point, this.log can be in the old format or the new format, be careful.</span><span class="WHIT">
<span class='line'>900</span> 
<span class='line'>901</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">postHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getSaveHandler</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>902</span> </span><span class="WHIT">			</span><span class="COMM">//	TODO: this should be a handlerResolver object or something ...</span><span class="WHIT">
<span class='line'>903</span> </span><span class="WHIT">			</span><span class="PUNC">(</span><span class="NAME">postHandler.indexOf</span><span class="PUNC">(</span><span class="STRN">'?'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">postHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'?'</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT">  </span><span class="NAME">postHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>904</span> </span><span class="WHIT">			</span><span class="COMM">// TODO: Need this id.</span><span class="WHIT">
<span class='line'>905</span> </span><span class="WHIT">			</span><span class="COMM">//postHandler += 'GridId=' + '&';</span><span class="WHIT">
<span class='line'>906</span> </span><span class="WHIT">			</span><span class="NAME">postHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'TableId='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>907</span> </span><span class="WHIT">			</span><span class="NAME">postHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&uid='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Date</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getTime</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>908</span> 
<span class='line'>909</span> </span><span class="WHIT">  			</span><span class="NAME">this.ajaxCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.reserve</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>910</span> 
<span class='line'>911</span> 
<span class='line'>912</span> </span><span class="WHIT">			</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">Boolean</span><span class="PUNC">(</span><span class="NAME">this.ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">"The datasource is serving too many connections. Please try again later. # current connections: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.inUse.length</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>913</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.handler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">postHandler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>914</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.responseType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>915</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>916</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.completeCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="NAME">this.saveComplete</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>917</span> </span><span class="WHIT">			</span><span class="COMM">//this.ajaxCallback.onPostComplete.subscribeOnce(this.saveComplete, this);</span><span class="WHIT">
<span class='line'>918</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.params</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.SaveCompleteEventArgs</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>919</span> 
<span class='line'>920</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.version</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">2.8</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.log.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e[@xac='i']"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.isAutoKeyEnabled</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>921</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>922</span> </span><span class="WHIT">				</span><span class="NAME">this.ajaxCallback.async</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>923</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>924</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>925</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.log.documentElement.nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"root"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>926</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>927</span> </span><span class="WHIT">				</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.log.xml.replace</span><span class="PUNC">(</span><span class="REGX">/xmlns:ntb=\"http:\/\/www.nitobi.com\"/g</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>928</span> </span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>929</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasourcestructure"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"FieldNames"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'|'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>930</span> </span><span class="WHIT">				</span><span class="NAME">fields.splice</span><span class="PUNC">(</span><span class="NAME">fields.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>931</span> </span><span class="WHIT">				</span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fields.join</span><span class="PUNC">(</span><span class="STRN">'|'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>932</span> </span><span class="WHIT">				</span><span class="NAME">this.log.documentElement.setAttribute</span><span class="PUNC">(</span><span class="STRN">"fields"</span><span class="PUNC">,</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>933</span> </span><span class="WHIT">				</span><span class="NAME">this.log.documentElement.setAttribute</span><span class="PUNC">(</span><span class="STRN">"keys"</span><span class="PUNC">,</span><span class="NAME">fields</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>934</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>935</span> 
<span class='line'>936</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.isAutoKeyEnabled</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.version</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>937</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>938</span> </span><span class="WHIT">				</span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"AutoKey is not supported in this schema version. You must upgrade to Nitobi Grid Xml Schema version 3 or greater."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>939</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>940</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>941</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallback.post</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>942</span> </span><span class="WHIT">			</span><span class="NAME">this.flushLog</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>943</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>944</span> </span><span class="WHIT">		</span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>945</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>946</span> </span><span class="WHIT">			</span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="NAME">err</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>947</span> </span><span class="WHIT">  			</span><span class="COMM">//_ntbAssert(false,"save : " + err.message);</span><span class="WHIT">
<span class='line'>948</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>949</span> 
<span class='line'>950</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>951</span> </span><span class="COMM">/**
<span class='line'>952</span>  * Clears the log.
<span class='line'>953</span>  */</span><span class="WHIT">
<span class='line'>954</span> </span><span class="NAME">nitobi.data.DataTable.prototype.flushLog</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>955</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>956</span> </span><span class="WHIT">	</span><span class="COMM">//	TODO: integrate the response back into our client model</span><span class="WHIT">
<span class='line'>957</span> </span><span class="WHIT">	</span><span class="COMM">//	For now we can leave it at assuming all operations succesful ...</span><span class="WHIT">
<span class='line'>958</span> </span><span class="WHIT">	</span><span class="COMM">//	so clear the log and the response should just be the new grid xml</span><span class="WHIT">
<span class='line'>959</span> </span><span class="WHIT">	</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createXmlDoc</span><span class="PUNC">(</span><span class="NAME">nitobi.data.DataTable.DEFAULT_LOG.replace</span><span class="PUNC">(</span><span class="REGX">/\{id\}/g</span><span class="PUNC">,</span><span class="NAME">this.id</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{fields\}/g</span><span class="PUNC">,</span><span class="NAME">this.columns</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{keys\}/g</span><span class="PUNC">,</span><span class="NAME">this.keys</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{defaults\}/g</span><span class="PUNC">,</span><span class="NAME">this.defaults</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">replace</span><span class="PUNC">(</span><span class="REGX">/\{types\}/g</span><span class="PUNC">,</span><span class="NAME">this.types</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>960</span> </span><span class="WHIT">	</span><span class="NAME">this.logData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>961</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>962</span> 
<span class='line'>963</span> </span><span class="COMM">/**
<span class='line'>964</span>  * @private
<span class='line'>965</span>  * Takes all the inserts from a server insert and 
<span class='line'>966</span>  * sets the keys for autokey
<span class='line'>967</span>  * @param {XmlDocument} xmlDoc The xml document from the server.
<span class='line'>968</span>  */</span><span class="WHIT">
<span class='line'>969</span> </span><span class="NAME">nitobi.data.DataTable.prototype.updateAutoKeys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlDoc</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>970</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>971</span> 
<span class='line'>972</span> </span><span class="WHIT">	</span><span class="KEYW">try</span><span class="WHIT">
<span class='line'>973</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>974</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">inserts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e[@xac=\'i\']'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>975</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">inserts</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">inserts</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>976</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>977</span> </span><span class="WHIT">			</span><span class="NAME">nitobi.lang.throwError</span><span class="PUNC">(</span><span class="STRN">"When updating keys from the server for AutoKey support, the inserts could not be parsed."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>978</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>979</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasourcestructure"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"keys"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>980</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">keys</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"undefined"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">keys</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">keys.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>981</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>982</span> </span><span class="WHIT">			</span><span class="NAME">nitobi.lang.throwError</span><span class="PUNC">(</span><span class="STRN">"When updating keys from the server for AutoKey support, no keys could be found. Ensure that the keys are sent in the request response."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>983</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>984</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">inserts.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>985</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>986</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getRecord</span><span class="PUNC">(</span><span class="NAME">inserts</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>987</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">keys.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>988</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>989</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">att</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">keys</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>990</span> </span><span class="WHIT">				</span><span class="NAME">record.setAttribute</span><span class="PUNC">(</span><span class="NAME">att</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">inserts</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="NAME">att</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>991</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>992</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>993</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>994</span> </span><span class="WHIT">	</span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>995</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>996</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.lang.throwError</span><span class="PUNC">(</span><span class="STRN">"When updating keys from the server for AutoKey support, the inserts could not be parsed."</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">err</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>997</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>998</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>999</span> 
<span class='line'>1000</span> </span><span class="COMM">/**
<span class='line'>1001</span>  * Handles the response from the save handler.
<span class='line'>1002</span>  * @param {XMLDocument} xd An XMLDocument containing the response from the save handler
<span class='line'>1003</span>  * @param {nitobi.data.SaveCompleteEventArgs} evtArgs Event arguments
<span class='line'>1004</span>  * @private
<span class='line'>1005</span>  */</span><span class="WHIT">
<span class='line'>1006</span> </span><span class="NAME">nitobi.data.DataTable.prototype.saveComplete</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evtArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1007</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1008</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evtArgs.response</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1009</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evtArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evtArgs.params</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1010</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: Empty try catch.</span><span class="WHIT">
<span class='line'>1011</span> 
<span class='line'>1012</span> </span><span class="WHIT">		</span><span class="KEYW">try</span><span class="WHIT">
<span class='line'>1013</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1014</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.isAutoKeyEnabled</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.version</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">2.8</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1015</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1016</span> </span><span class="WHIT">				</span><span class="NAME">this.updateAutoKeys</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1017</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1018</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.version</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">2.8</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">this.onGenerateKey</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1019</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1020</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rows</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//insert"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1021</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">rows.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1022</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1023</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xk</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rows</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"xk"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1024</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">xk</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1025</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1026</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">record</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.findWithoutMap</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rows</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"xid"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1027</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">key</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="STRN">"_xk"</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1028</span> </span><span class="WHIT">						</span><span class="NAME">record.setAttribute</span><span class="PUNC">(</span><span class="NAME">key</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xk</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1029</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1030</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1031</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1032</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">evtArgs.result</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1033</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1034</span> </span><span class="WHIT">				</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">errorMessage</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"Data Save Error:"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">errorMessage</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">EBA_EM_ATTRIBUTE_ERROR</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">EBA_ERROR</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1035</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1036</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>1037</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'/root'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1038</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1039</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1040</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1041</span> </span><span class="WHIT">				</span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.getAttribute</span><span class="PUNC">(</span><span class="STRN">'error'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1042</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1043</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1044</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1045</span> </span><span class="WHIT">				</span><span class="NAME">this.setHandlerError</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1046</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1047</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1048</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1049</span> </span><span class="WHIT">				</span><span class="NAME">this.setHandlerError</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1050</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1051</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallbackPool.release</span><span class="PUNC">(</span><span class="NAME">this.ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1052</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">afterSaveArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.OnAfterSaveEventArgs</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1053</span> </span><span class="WHIT">			</span><span class="NAME">evtArgs.callback.call</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">afterSaveArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1054</span> </span><span class="WHIT">			</span><span class="COMM">//	TODO: need to restore state - ie set focus on the appropriate cell ...		</span><span class="WHIT">
<span class='line'>1055</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1056</span> </span><span class="WHIT">		</span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1057</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1058</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallbackPool.release</span><span class="PUNC">(</span><span class="NAME">this.ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1059</span> </span><span class="WHIT">			</span><span class="NAME">ebaErrorReport</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">,</span><span class="NAME">EBA_ERROR</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1060</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1061</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1062</span> </span><span class="COMM">/**
<span class='line'>1063</span>  * Makes a hash for relating column names to XML nodes in the data.
<span class='line'>1064</span>  */</span><span class="WHIT">
<span class='line'>1065</span> </span><span class="NAME">nitobi.data.DataTable.prototype.makeFieldMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1066</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1067</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oXMLs</span><span class="PUNC">=</span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1068</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cf</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1069</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ck</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1070</span> </span><span class="WHIT">		</span><span class="NAME">this.fieldMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1071</span> 
<span class='line'>1072</span> </span><span class="WHIT">		</span><span class="COMM">//	This needs to be changed to transform some XML into JavaScript that is then eval'ed ...</span><span class="WHIT">
<span class='line'>1073</span> 
<span class='line'>1074</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cF</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.columns.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1075</span> 
<span class='line'>1076</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">cF</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1077</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1078</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fname</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.columns</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1079</span> </span><span class="WHIT">			</span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">fname</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getFieldName</span><span class="PUNC">(</span><span class="NAME">ck</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1080</span> </span><span class="WHIT">			</span><span class="NAME">ck</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1081</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1082</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1083</span> 
<span class='line'>1084</span> </span><span class="COMM">/**
<span class='line'>1085</span>  * Returns the XPath for the column data at the given column index.
<span class='line'>1086</span>  */</span><span class="WHIT">
<span class='line'>1087</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getFieldName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">columnIndex</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1088</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1089</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ck1</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">columnIndex</span><span class="PUNC">%</span><span class="NUMB">26</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1090</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ck2</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">columnIndex</span><span class="PUNC">/</span><span class="NUMB">26</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1091</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="STRN">"@"</span><span class="PUNC">+</span><span class="PUNC">(</span><span class="NAME">ck2</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">?</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NUMB">96</span><span class="PUNC">+</span><span class="NAME">ck2</span><span class="PUNC">)</span><span class="PUNC">:</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NUMB">97</span><span class="PUNC">+</span><span class="NAME">ck1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1092</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1093</span> </span><span class="COMM">/**
<span class='line'>1094</span>  * Returns the set of records with the given value at the given field.
<span class='line'>1095</span>  * @param {String} fieldName the field to search at
<span class='line'>1096</span>  * @param {String} value the value to search for
<span class='line'>1097</span>  * @type Array
<span class='line'>1098</span>  */</span><span class="WHIT">
<span class='line'>1099</span> </span><span class="NAME">nitobi.data.DataTable.prototype.find</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">fieldName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1100</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1101</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">field</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">fieldName</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1102</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">field</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1103</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1104</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.findWithoutMap</span><span class="PUNC">(</span><span class="NAME">field</span><span class="PUNC">,</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1105</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1106</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1107</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1108</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1109</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1110</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1111</span> </span><span class="COMM">/**
<span class='line'>1112</span>  * @private
<span class='line'>1113</span>  */</span><span class="WHIT">
<span class='line'>1114</span> </span><span class="NAME">nitobi.data.DataTable.prototype.findWithoutMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">field</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1115</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1116</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">field.charAt</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"@"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1117</span> </span><span class="WHIT">		</span><span class="NAME">field</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"@"</span><span class="PUNC">+</span><span class="NAME">field</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1118</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e['</span><span class="PUNC">+</span><span class="NAME">field</span><span class="PUNC">+</span><span class="STRN">'="'</span><span class="PUNC">+</span><span class="NAME">value</span><span class="PUNC">+</span><span class="STRN">'"]'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1119</span> </span><span class="PUNC">}</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1120</span> 
<span class='line'>1121</span> </span><span class="COMM">/**
<span class='line'>1122</span>  * Performs a local sort of the data
<span class='line'>1123</span>  * Note: This way of sorting is only useful when we have all the data residing in the XML, otherwise data should be sorted remotely
<span class='line'>1124</span>  * @param {String} column the identifier of the column to sort by
<span class='line'>1125</span>  * @param {String} dir the direction to sort 'Desc'|'Asc'
<span class='line'>1126</span>  * @param {String} type the type of sort to perform 'number'|'text'
<span class='line'>1127</span>  * @param {Boolean} local whether the sort is local or remote - if remote, the column 
<span class='line'>1128</span>  * and direction will be set for the next server request
<span class='line'>1129</span>  * @public
<span class='line'>1130</span>  */</span><span class="WHIT">
<span class='line'>1131</span> </span><span class="NAME">nitobi.data.DataTable.prototype.sort</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">column</span><span class="PUNC">,</span><span class="NAME">dir</span><span class="PUNC">,</span><span class="NAME">type</span><span class="PUNC">,</span><span class="NAME">local</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1132</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1133</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">local</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1134</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1135</span> </span><span class="WHIT">		</span><span class="COMM">//this.filter = null;</span><span class="WHIT">
<span class='line'>1136</span> </span><span class="WHIT">		</span><span class="NAME">column</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">column</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1137</span> </span><span class="WHIT">		</span><span class="NAME">column</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">column.substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1138</span> </span><span class="WHIT">		</span><span class="NAME">dir</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">dir</span><span class="PUNC">==</span><span class="STRN">"Desc"</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="STRN">"descending"</span><span class="PUNC">:</span><span class="STRN">"ascending"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1139</span> </span><span class="WHIT">		</span><span class="NAME">type</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">type</span><span class="PUNC">==</span><span class="STRN">"number"</span><span class="PUNC">)</span><span class="PUNC">?</span><span class="STRN">"number"</span><span class="PUNC">:</span><span class="STRN">"text"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1140</span> </span><span class="WHIT">		</span><span class="NAME">this.sortXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"column"</span><span class="PUNC">,</span><span class="NAME">column</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1141</span> </span><span class="WHIT">		</span><span class="NAME">this.sortXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"dir"</span><span class="PUNC">,</span><span class="NAME">dir</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1142</span> </span><span class="WHIT">		</span><span class="NAME">this.sortXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"type"</span><span class="PUNC">,</span><span class="NAME">type</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1143</span> </span><span class="WHIT">		</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.sortXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1144</span> </span><span class="WHIT">		</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"DataSorted"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1145</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1146</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1147</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1148</span> </span><span class="WHIT">		</span><span class="NAME">this.sortColumn</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">column</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1149</span> </span><span class="WHIT">		</span><span class="NAME">this.sortDir</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">dir</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">'Asc'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1150</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1151</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1152</span> 
<span class='line'>1153</span> </span><span class="COMM">/**
<span class='line'>1154</span>  * Sets the number of rows that are in the remote datasource 
<span class='line'>1155</span>  * Note: We consider adding rows locally to increase the remote datasource size even if they haven't been saved yet. Same true for deletes
<span class='line'>1156</span>  * @private
<span class='line'>1157</span>  */</span><span class="WHIT">
<span class='line'>1158</span> </span><span class="NAME">nitobi.data.DataTable.prototype.syncRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1159</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1160</span> </span><span class="WHIT">	</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">this.descriptor.estimatedRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1161</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1162</span> </span><span class="COMM">/**
<span class='line'>1163</span>  * Sets the number of rows that are in the remote datasource 
<span class='line'>1164</span>  * Note: We consider adding rows locally to increase the remote datasource size even if they haven't been saved yet. Same true for deletes
<span class='line'>1165</span>  * @private
<span class='line'>1166</span>  */</span><span class="WHIT">
<span class='line'>1167</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setRemoteRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">rows</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1168</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1169</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">previousCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.remoteRowCount</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1170</span> </span><span class="WHIT">	</span><span class="NAME">this.remoteRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rows</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1171</span> </span><span class="WHIT">  	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.remoteRowCount</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">previousCount</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1172</span> </span><span class="WHIT">		</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowCountChanged"</span><span class="PUNC">,</span><span class="NAME">rows</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1173</span> </span><span class="WHIT">  	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1174</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1175</span> </span><span class="COMM">/**
<span class='line'>1176</span>  * Gets the number of rows that are in the remote datasource 
<span class='line'>1177</span>  * Note: We consider adding rows locally to increase the remote datasource size even if they haven't been saved yet. Same true for deletes
<span class='line'>1178</span>  * @public
<span class='line'>1179</span>  * @returns {int}
<span class='line'>1180</span>  */</span><span class="WHIT">
<span class='line'>1181</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getRemoteRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1182</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1183</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.remoteRowCount</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1184</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1185</span> </span><span class="COMM">/**
<span class='line'>1186</span>  * Returns the number of rows that are actually in the local recordset. This number is not used in caching mode.
<span class='line'>1187</span>  * @returns {int}
<span class='line'>1188</span>  */</span><span class="WHIT">
<span class='line'>1189</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getRows</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1190</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1191</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1192</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1193</span> 
<span class='line'>1194</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getXmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1195</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1196</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1197</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1198</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1199</span> </span><span class="COMM">/**
<span class='line'>1200</span>  * @private
<span class='line'>1201</span>  */</span><span class="WHIT">
<span class='line'>1202</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getRowNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1203</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1204</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectNodes</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1205</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1206</span> </span><span class="COMM">/**
<span class='line'>1207</span>  * Returns the number of columns in the DataTable.
<span class='line'>1208</span>  * @returns {int}
<span class='line'>1209</span>  */</span><span class="WHIT">
<span class='line'>1210</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getColumns</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1211</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1212</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.fieldMap.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1213</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1214</span> 
<span class='line'>1215</span> 
<span class='line'>1216</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1217</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1218</span> </span><span class="COMM">/**
<span class='line'>1219</span>  * Appends the given parameter to the GetHandler value when requests for data are made to the server.
<span class='line'>1220</span>  * @param {string} name The name of the parameter to be appended to the querystring.
<span class='line'>1221</span>  * @param {string} value The value of the parameter to be appended to the querystring.
<span class='line'>1222</span>  */</span><span class="WHIT">
<span class='line'>1223</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setGetHandlerParameter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1224</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1225</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.getHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.getHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1226</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1227</span> </span><span class="WHIT">		</span><span class="NAME">this.getHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.html.setUrlParameter</span><span class="PUNC">(</span><span class="NAME">this.getHandler</span><span class="PUNC">,</span><span class="NAME">name</span><span class="PUNC">,</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1228</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1229</span> </span><span class="WHIT">	</span><span class="NAME">this.getHandlerArgs</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1230</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1231</span> 
<span class='line'>1232</span> </span><span class="COMM">/**
<span class='line'>1233</span>  * Appends the given parameter to the SaveHandler value when requests for data are made to the server.
<span class='line'>1234</span>  * @param {string} name The name of the parameter to be appended to the querystring.
<span class='line'>1235</span>  * @param {string} value The value of the parameter to be appended to the querystring.
<span class='line'>1236</span>  */</span><span class="WHIT">
<span class='line'>1237</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setSaveHandlerParameter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1238</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1239</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.postHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.postHandler</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1240</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1241</span> </span><span class="WHIT">		</span><span class="NAME">this.postHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.html.setUrlParameter</span><span class="PUNC">(</span><span class="NAME">this.getSaveHandler</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NAME">name</span><span class="PUNC">,</span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1242</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1243</span> </span><span class="WHIT">	</span><span class="NAME">this.saveHandlerArgs</span><span class="PUNC">[</span><span class="NAME">name</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1244</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1245</span> 
<span class='line'>1246</span> </span><span class="COMM">/**
<span class='line'>1247</span>  * Returns the number of entries in the change log.
<span class='line'>1248</span>  * @returns {int}
<span class='line'>1249</span>  */</span><span class="WHIT">
<span class='line'>1250</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getChangeLogSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1251</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1252</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">this.log</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1253</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1254</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1255</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1256</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.log.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1257</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1258</span> 
<span class='line'>1259</span> </span><span class="COMM">/**
<span class='line'>1260</span>  * Returns the change log XML document.
<span class='line'>1261</span>  * @returns {XMLDocument}
<span class='line'>1262</span>  */</span><span class="WHIT">
<span class='line'>1263</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getChangeLogXmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1264</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1265</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.log</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1266</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1267</span> 
<span class='line'>1268</span> </span><span class="COMM">/**
<span class='line'>1269</span>  * Returns the data in the DataTable as an XML document.
<span class='line'>1270</span>  * @returns {XMLDocument}
<span class='line'>1271</span>  */</span><span class="WHIT">
<span class='line'>1272</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getDataXmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1273</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1274</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1275</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1276</span> 
<span class='line'>1277</span> </span><span class="COMM">/**
<span class='line'>1278</span>  * @ignore
<span class='line'>1279</span>  */</span><span class="WHIT">
<span class='line'>1280</span> </span><span class="NAME">nitobi.data.DataTable.prototype.dispose</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1281</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1282</span> </span><span class="WHIT">	</span><span class="NAME">this.flush</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1283</span> </span><span class="WHIT">	</span><span class="NAME">this.ajaxCallbackPool.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1284</span> 
<span class='line'>1285</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">item</span><span class="WHIT"> </span><span class="KEYW">in</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1286</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1287</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">[</span><span class="NAME">item</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">[</span><span class="NAME">item</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">dispose</span><span class="WHIT"> </span><span class="KEYW">instanceof</span><span class="WHIT"> </span><span class="NAME">Function</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1288</span> </span><span class="WHIT">			</span><span class="KEYW">this</span><span class="PUNC">[</span><span class="NAME">item</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">dispose</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1289</span> </span><span class="WHIT">		</span><span class="KEYW">this</span><span class="PUNC">[</span><span class="NAME">item</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1290</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1291</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1292</span> 
<span class='line'>1293</span> 
<span class='line'>1294</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1295</span> </span><span class="COMM">// BOUND</span><span class="WHIT">
<span class='line'>1296</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1297</span> </span><span class="COMM">/**
<span class='line'>1298</span>  * Makes a request to the server with no start or pagesize parameters.
<span class='line'>1299</span>  * @param {object} context
<span class='line'>1300</span>  * @param {function} callback
<span class='line'>1301</span>  * @param {function} errorCallback
<span class='line'>1302</span>  * @public
<span class='line'>1303</span>  */</span><span class="WHIT">
<span class='line'>1304</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getTable</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1305</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1306</span> </span><span class="WHIT">	</span><span class="NAME">this.errorCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1307</span> 
<span class='line'>1308</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ajaxCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.reserve</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1309</span> 
<span class='line'>1310</span> </span><span class="WHIT">	</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">Boolean</span><span class="PUNC">(</span><span class="NAME">ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">"The datasource is serving too many connections. Please try again later. # current connections: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.inUse.length</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1311</span> 
<span class='line'>1312</span> </span><span class="WHIT">	</span><span class="COMM">// This is an editor's gethandler</span><span class="WHIT">
<span class='line'>1313</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getGetHandler</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1314</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.handler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1315</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.responseType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1316</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1317</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.completeCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="NAME">this.getComplete</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1318</span> </span><span class="COMM">//	ajaxCallback.onGetComplete.subscribeOnce(this.getComplete, this);</span><span class="WHIT">
<span class='line'>1319</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: Is this right, 4th null. What is the pagesize here?</span><span class="WHIT">
<span class='line'>1320</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.async</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.async</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1321</span> </span><span class="WHIT">	</span><span class="COMM">// StartXi is supposed to 0 in a getTable request ... when are these even used?</span><span class="WHIT">
<span class='line'>1322</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.params</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.GetCompleteEventArgs</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="NAME">ajaxCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1323</span> 
<span class='line'>1324</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.async</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1325</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1326</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.async</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1327</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.getComplete</span><span class="PUNC">(</span><span class="PUNC">{</span><span class="STRN">"response"</span><span class="PUNC">:</span><span class="NAME">ajaxCallback.get</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"params"</span><span class="PUNC">:</span><span class="NAME">ajaxCallback.params</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1328</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1329</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1330</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1331</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.get</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1332</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1333</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>1334</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1335</span> 
<span class='line'>1336</span> </span><span class="COMM">/**
<span class='line'>1337</span>  * This function is executed as the callback function when data has returned from the paging request.
<span class='line'>1338</span>  * This method will check the response for validity, check the data format for backwards compatibility, 
<span class='line'>1339</span>  * create a new XML doc if necessary, adjust the row #'s (xi's), remove the range from the request cache,
<span class='line'>1340</span>  * update the cachemap.
<span class='line'>1341</span>  * @param {XmlElement} xd The xml document payload returned by the paging request
<span class='line'>1342</span>  * @param {nitobi.data.GetCompleteEventArgs} getCompleteEvtArgs The event arguments such as startXi returned along with the response payload
<span class='line'>1343</span>  */</span><span class="WHIT">
<span class='line'>1344</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getComplete</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evtArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1345</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1346</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evtArgs.response</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1347</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">evtArgs.params</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1348</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1349</span> </span><span class="WHIT">		</span><span class="COMM">// Used only by mode != unbound</span><span class="WHIT">
<span class='line'>1350</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">!=</span><span class="STRN">"caching"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">//(this.id != "_default")</span><span class="WHIT">
<span class='line'>1351</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1352</span> </span><span class="WHIT">			</span><span class="COMM">// Clear existing data if mode is non-caching</span><span class="WHIT">
<span class='line'>1353</span> </span><span class="WHIT">			</span><span class="NAME">this.xmlDoc</span><span class="PUNC">=</span><span class="NAME">nitobi.xml.createXmlDoc</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1354</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1355</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">xd.xml</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">''</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">xd.xml</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1356</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1357</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"No parse error."</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1358</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">nitobi.xml.hasParseError</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1359</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1360</span> </span><span class="WHIT">			    </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1361</span> </span><span class="WHIT">			    </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1362</span> </span><span class="WHIT">			        </span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"Blank Response was Given"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1363</span> </span><span class="WHIT">			    </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1364</span> </span><span class="WHIT">			    </span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1365</span> </span><span class="WHIT">			    </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1366</span> </span><span class="WHIT">				    </span><span class="NAME">error</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.getParseErrorReason</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1367</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">				   </span><span class="WHIT">
<span class='line'>1368</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1369</span> </span><span class="WHIT">			</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">!=</span><span class="NAME">this.errorCallback</span><span class="PUNC">,</span><span class="STRN">"The server returned either an error or invalid XML but there is no error handler in the DataTable.\nThe parse error content was:\n"</span><span class="PUNC">+</span><span class="NAME">error</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1370</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.errorCallback</span><span class="PUNC">)</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1371</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1372</span> </span><span class="WHIT">				</span><span class="NAME">this.errorCallback.call</span><span class="PUNC">(</span><span class="NAME">this.context</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1373</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1374</span> </span><span class="WHIT">			</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"DataReady"</span><span class="PUNC">,</span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1375</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1376</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1377</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1378</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1379</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">this.successCallback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1380</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1381</span> </span><span class="WHIT">				</span><span class="NAME">this.successCallback.call</span><span class="PUNC">(</span><span class="NAME">this.context</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1382</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1383</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1384</span> </span><span class="WHIT">		</span><span class="COMM">// If this is our first encounter with the data then autoconfigure the datatable parameters (paging stuff, columns, #rows, etc)</span><span class="WHIT">
<span class='line'>1385</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.configured</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1386</span> </span><span class="WHIT">			</span><span class="NAME">this.configureFromData</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1387</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1388</span> 
<span class='line'>1389</span> </span><span class="WHIT">		</span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parseResponse</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1390</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1391</span> </span><span class="WHIT">		</span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.assignRowIds</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1392</span> 
<span class='line'>1393</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rowNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1394</span> </span><span class="WHIT">		</span><span class="NAME">rowNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectNodes</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasource[@id='"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"']/"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"data/"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1395</span> 
<span class='line'>1396</span> </span><span class="WHIT">		</span><span class="COMM">// This gets set to the index of the last row that was returned.</span><span class="WHIT">
<span class='line'>1397</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lastRowReturned</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1398</span> </span><span class="WHIT">		</span><span class="COMM">// This gets set to the number of rows returned.</span><span class="WHIT">
<span class='line'>1399</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numRowsReturned</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rowNodes.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1400</span> 
<span class='line'>1401</span> </span><span class="WHIT">		</span><span class="COMM">// If the pagesize is null, we got whatever the server would give us.</span><span class="WHIT">
<span class='line'>1402</span> </span><span class="WHIT">		</span><span class="COMM">// Update the evt args according to what was delievered by the server.</span><span class="WHIT">
<span class='line'>1403</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs.pageSize</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1404</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1405</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs.pageSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">numRowsReturned</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1406</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs.lastRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.startXi</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.pageSize</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1407</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs.firstRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.startXi</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1408</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1409</span> 
<span class='line'>1410</span> 
<span class='line'>1411</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">numRowsReturned</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1412</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1413</span> </span><span class="WHIT">			</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">rowNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs.startXi</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">"The gethandler returned a different first row than requested."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1414</span> 
<span class='line'>1415</span> </span><span class="COMM">//			lastRowReturned = getCompleteEvtArgs.lastRow;</span><span class="WHIT">
<span class='line'>1416</span> </span><span class="WHIT">			</span><span class="COMM">//	Here we check if the zero based index (xi) of the last record returned from the server </span><span class="WHIT">
<span class='line'>1417</span> </span><span class="WHIT">			</span><span class="COMM">//	is equal to the requested pageSize plus the starting xi minus 1...</span><span class="WHIT">
<span class='line'>1418</span> </span><span class="WHIT">	</span><span class="COMM">//			if (rowNodes[rowNodes.length-1].getAttribute("xi") != (getCompleteEvtArgs.pageSize+getCompleteEvtArgs.startXi-1))</span><span class="WHIT">
<span class='line'>1419</span> </span><span class="WHIT">	</span><span class="COMM">//			{</span><span class="WHIT">
<span class='line'>1420</span> </span><span class="WHIT">				</span><span class="NAME">lastRowReturned</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">rowNodes</span><span class="PUNC">[</span><span class="NAME">rowNodes.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1421</span> 
<span class='line'>1422</span> </span><span class="WHIT">				</span><span class="COMM">// lastRowReturned is used in descriptor to determine if we </span><span class="WHIT">
<span class='line'>1423</span> </span><span class="WHIT">				</span><span class="COMM">// did not receive all the expected rows and are thus on the last page.</span><span class="WHIT">
<span class='line'>1424</span> </span><span class="WHIT">	</span><span class="COMM">//				getCompleteEvtArgs.lastRowReturned = lastRowReturned;</span><span class="WHIT">
<span class='line'>1425</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1426</span> </span><span class="WHIT">				</span><span class="COMM">// This is the last page.</span><span class="WHIT">
<span class='line'>1427</span> </span><span class="COMM">//				getCompleteEvtArgs.lastPage=true;</span><span class="WHIT">
<span class='line'>1428</span> </span><span class="COMM">//	  			this.fire("RowCountKnown",actualLastRow);</span><span class="WHIT">
<span class='line'>1429</span> </span><span class="COMM">//			}</span><span class="WHIT">
<span class='line'>1430</span> 
<span class='line'>1431</span> </span><span class="WHIT">			</span><span class="COMM">//	Add the range to the cache map.</span><span class="WHIT">
<span class='line'>1432</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"paging"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1433</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1434</span> </span><span class="WHIT">				</span><span class="NAME">this.dataCache.insert</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.pageSize</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">				</span><span class="WHIT">
<span class='line'>1435</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1436</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1437</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1438</span> </span><span class="WHIT">				</span><span class="NAME">this.dataCache.insert</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs.firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRowReturned</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1439</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1440</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1441</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1442</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1443</span> </span><span class="WHIT">			</span><span class="NAME">lastRowReturned</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1444</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs.pageSize</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1445</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.totalRowCount</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1446</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1447</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pct</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.descriptor.lastKnownRow</span><span class="PUNC">/</span><span class="NAME">this.descriptor.estimatedRowCount</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1448</span> </span><span class="WHIT">				</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"PastEndOfData"</span><span class="PUNC">,</span><span class="NAME">pct</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1449</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1450</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1451</span> 
<span class='line'>1452</span> </span><span class="WHIT">		</span><span class="NAME">getCompleteEvtArgs.numRowsReturned</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">numRowsReturned</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1453</span> </span><span class="WHIT">		</span><span class="NAME">getCompleteEvtArgs.lastRowReturned</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lastRowReturned</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1454</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1455</span> </span><span class="WHIT">		</span><span class="COMM">// Remove the received request from the cache.</span><span class="WHIT">
<span class='line'>1456</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">startXi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.startXi</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1457</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.pageSize</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1458</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isNaN</span><span class="PUNC">(</span><span class="NAME">startXi</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="NAME">isNaN</span><span class="PUNC">(</span><span class="NAME">pageSize</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">startXi</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1459</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1460</span> </span><span class="WHIT">			</span><span class="NAME">this.requestCache.remove</span><span class="PUNC">(</span><span class="NAME">startXi</span><span class="PUNC">,</span><span class="NAME">startXi</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1461</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1462</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1463</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">!=</span><span class="STRN">"caching"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1464</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1465</span> </span><span class="WHIT">			</span><span class="COMM">// in both static and paging modes we just take the data from the server </span><span class="WHIT">
<span class='line'>1466</span> </span><span class="WHIT">			</span><span class="COMM">// and put it into our local xml document.</span><span class="WHIT">
<span class='line'>1467</span> 
<span class='line'>1468</span> </span><span class="WHIT">			</span><span class="COMM">// Use replaceData which will _only_ replace the data and no events will be fired</span><span class="WHIT">
<span class='line'>1469</span> </span><span class="WHIT">			</span><span class="COMM">// or row counts being set ... this happens later by the descriptor.</span><span class="WHIT">
<span class='line'>1470</span> </span><span class="WHIT">			</span><span class="NAME">this.replaceData</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1471</span> 
<span class='line'>1472</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1473</span> </span><span class="WHIT">			</span><span class="COMM">//	Otherwise we need to merge the data from the request with that in our datasource</span><span class="WHIT">
<span class='line'>1474</span> </span><span class="WHIT">			</span><span class="NAME">this.mergeData</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1475</span> 
<span class='line'>1476</span> </span><span class="COMM">/*
<span class='line'>1477</span> 			// Added by james 
<span class='line'>1478</span> 			var previousCount = this.remoteRowCount;
<span class='line'>1479</span> 			var previousKnown = this.rowCountKnown;
<span class='line'>1480</span> 		  	this.descriptor.update(getCompleteEvtArgs);
<span class='line'>1481</span> 		  	
<span class='line'>1482</span> 		  	this.remoteRowCount = this.descriptor.estimatedRowCount;
<span class='line'>1483</span> 		  	this.rowCountKnown = this.descriptor.isAtEndOfTable;
<span class='line'>1484</span> 		  	if (this.remoteRowCount != previousCount) {
<span class='line'>1485</span> 		  			this.fire("RowCountChanged",this.remoteRowCount);
<span class='line'>1486</span> 		  	}
<span class='line'>1487</span> 		  	if (this.rowCountKnown != previousKnown) {
<span class='line'>1488</span> 		  			this.fire("RowCountKnown",this.remoteRowCount);
<span class='line'>1489</span> 		  	}
<span class='line'>1490</span> 	*/</span><span class="WHIT">
<span class='line'>1491</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1492</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1493</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">this.totalRowCount</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1494</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1495</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">totalRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//ntb:datasource"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"totalrowcount"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1496</span> </span><span class="WHIT">			</span><span class="NAME">totalRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">totalRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1497</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isNaN</span><span class="PUNC">(</span><span class="NAME">totalRowCount</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1498</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1499</span> </span><span class="WHIT">				</span><span class="NAME">this.totalRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">totalRowCount</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1500</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1501</span> </span><span class="WHIT">			</span><span class="COMM">// TODO: Should fire an event here to notify all interested parties that we have</span><span class="WHIT">
<span class='line'>1502</span> </span><span class="WHIT">			</span><span class="COMM">// all the rows</span><span class="WHIT">
<span class='line'>1503</span> </span><span class="WHIT">			</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"TotalRowCountReady"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.totalRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1504</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1505</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1506</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//ntb:datasource"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"parentfield"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1507</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">parentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//ntb:datasource"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"parentvalue"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1508</span> </span><span class="WHIT">		</span><span class="NAME">this.parentField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentField</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1509</span> </span><span class="WHIT">		</span><span class="NAME">this.parentValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentValue</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1510</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1511</span> </span><span class="WHIT">		</span><span class="NAME">this.updateFromDescriptor</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1512</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1513</span> </span><span class="WHIT">		</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowCountReady"</span><span class="PUNC">,</span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1514</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.ajaxCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1515</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1516</span> </span><span class="WHIT">			</span><span class="COMM">//	We need to check that the ajaxCallback is not null before relaesing it</span><span class="WHIT">
<span class='line'>1517</span> </span><span class="WHIT">			</span><span class="COMM">//	It could be the case the ajaxCallback object was not needed because the</span><span class="WHIT">
<span class='line'>1518</span> </span><span class="WHIT">			</span><span class="COMM">//	data was already present in the DataSource</span><span class="WHIT">
<span class='line'>1519</span> </span><span class="WHIT">			</span><span class="NAME">this.ajaxCallbackPool.release</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs.ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1520</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1521</span> 
<span class='line'>1522</span> </span><span class="WHIT">		</span><span class="NAME">this.executeRequests</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1523</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1524</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1525</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1526</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1527</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1528</span> </span><span class="WHIT">			</span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node.getAttribute</span><span class="PUNC">(</span><span class="STRN">'error'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1529</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1530</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1531</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1532</span> </span><span class="WHIT">			</span><span class="NAME">this.setHandlerError</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1533</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1534</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1535</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1536</span> </span><span class="WHIT">			</span><span class="NAME">this.setHandlerError</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1537</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1538</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1539</span> </span><span class="WHIT">		</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"DataReady"</span><span class="PUNC">,</span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1540</span> 
<span class='line'>1541</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.callback</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.context</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1542</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1543</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs.callback.call</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs.context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1544</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs.dispose</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1545</span> </span><span class="WHIT">			</span><span class="NAME">getCompleteEvtArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1546</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1547</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1548</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1549</span> </span><span class="WHIT">			</span><span class="COMM">// return the getCompleteEvtArgs to the caller ... </span><span class="WHIT">
<span class='line'>1550</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1551</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1552</span> 
<span class='line'>1553</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1554</span> 
<span class='line'>1555</span> </span><span class="COMM">/**
<span class='line'>1556</span>  * @private
<span class='line'>1557</span>  */</span><span class="WHIT">
<span class='line'>1558</span> </span><span class="NAME">nitobi.data.DataTable.prototype.executeRequests</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1559</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1560</span> </span><span class="WHIT">	</span><span class="COMM">// Execute all the functions on the request queue, then reset the queue.</span><span class="WHIT">
<span class='line'>1561</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oldRequests</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.requestQueue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1562</span> </span><span class="WHIT">	</span><span class="NAME">this.requestQueue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1563</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">oldRequests.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1564</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1565</span> </span><span class="WHIT">		</span><span class="NAME">oldRequests</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">call</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1566</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1567</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1568</span> </span><span class="COMM">/**
<span class='line'>1569</span>  * @private
<span class='line'>1570</span>  * Updates information related to paging such as whether the number of records on the server is known and what the currently estimated rowcount is.
<span class='line'>1571</span>  */</span><span class="WHIT">
<span class='line'>1572</span> </span><span class="NAME">nitobi.data.DataTable.prototype.updateFromDescriptor</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1573</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1574</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.totalRowCount</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1575</span> </span><span class="WHIT">  		</span><span class="NAME">this.descriptor.update</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1576</span> </span><span class="WHIT">  	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"paging"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1577</span> </span><span class="WHIT">  	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1578</span> </span><span class="WHIT">  		</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">getCompleteEvtArgs.numRowsReturned</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1579</span> </span><span class="WHIT">  	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1580</span> </span><span class="WHIT">  	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1581</span> </span><span class="WHIT">  	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1582</span> </span><span class="WHIT">  		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.totalRowCount</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1583</span> </span><span class="WHIT">  			</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">this.getTotalRowCount</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1584</span> </span><span class="WHIT">  		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1585</span> </span><span class="WHIT">  			</span><span class="NAME">this.setRemoteRowCount</span><span class="PUNC">(</span><span class="NAME">this.descriptor.estimatedRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1586</span> </span><span class="WHIT">  	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1587</span> </span><span class="WHIT">  	</span><span class="NAME">this.setRowCountKnown</span><span class="PUNC">(</span><span class="NAME">this.descriptor.isAtEndOfTable</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1588</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1589</span> 
<span class='line'>1590</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setRowCountKnown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">known</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1591</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1592</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: this has to be merged with the fireProjectionUpdatedEvent stuff in descriptor</span><span class="WHIT">
<span class='line'>1593</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">previousKnown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.rowCountKnown</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1594</span> </span><span class="WHIT">	</span><span class="NAME">this.rowCountKnown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">known</span><span class="WHIT">
<span class='line'>1595</span> </span><span class="WHIT">  	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">known</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">this.rowCountKnown</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">previousKnown</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>1596</span> </span><span class="WHIT">  	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1597</span> </span><span class="WHIT">		</span><span class="NAME">this.fire</span><span class="PUNC">(</span><span class="STRN">"RowCountKnown"</span><span class="PUNC">,</span><span class="NAME">this.remoteRowCount</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1598</span> </span><span class="WHIT">  	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1599</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1600</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getRowCountKnown</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1601</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1602</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.rowCountKnown</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1603</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1604</span> </span><span class="COMM">/**
<span class='line'>1605</span>  * @private
<span class='line'>1606</span>  */</span><span class="WHIT">
<span class='line'>1607</span> </span><span class="NAME">nitobi.data.DataTable.prototype.configureFromData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1608</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1609</span> </span><span class="WHIT">	</span><span class="NAME">this.version</span><span class="PUNC">=</span><span class="NAME">this.inferDataVersion</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1610</span> 
<span class='line'>1611</span> </span><span class="WHIT">	</span><span class="COMM">// Get columns out of data</span><span class="WHIT">
<span class='line'>1612</span> </span><span class="WHIT">	</span><span class="COMM">// Get total records on server</span><span class="WHIT">
<span class='line'>1613</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1614</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"unbound"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1615</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1616</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"static"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1617</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1618</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"paging"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1619</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1620</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"caching"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1621</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1622</span> </span><span class="WHIT">			</span><span class="COMM">//firstResponseRowXi</span><span class="WHIT">
<span class='line'>1623</span> </span><span class="WHIT">			</span><span class="COMM">//lastResponseRowXi</span><span class="WHIT">
<span class='line'>1624</span> </span><span class="WHIT">			</span><span class="COMM">//rowsInResponse</span><span class="WHIT">
<span class='line'>1625</span> </span><span class="WHIT">			</span><span class="COMM">//rowsRequested</span><span class="WHIT">
<span class='line'>1626</span> </span><span class="WHIT">			</span><span class="COMM">//firstRequestRowXi</span><span class="WHIT">
<span class='line'>1627</span> </span><span class="WHIT">			</span><span class="COMM">//laststRequestRowXi</span><span class="WHIT">
<span class='line'>1628</span> </span><span class="WHIT">			</span><span class="COMM">//firstPageRow</span><span class="WHIT">
<span class='line'>1629</span> </span><span class="WHIT">			</span><span class="COMM">//lastPageRow</span><span class="WHIT">
<span class='line'>1630</span> </span><span class="WHIT">			</span><span class="COMM">//ActualTotalRows</span><span class="WHIT">
<span class='line'>1631</span> </span><span class="WHIT">			</span><span class="COMM">//PredictedTotalRows</span><span class="WHIT">
<span class='line'>1632</span> </span><span class="WHIT">			</span><span class="COMM">//lastPage</span><span class="WHIT">
<span class='line'>1633</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1634</span> 
<span class='line'>1635</span> </span><span class="COMM">/**
<span class='line'>1636</span>  * Merges the data from an XML document into the DataTable XML. DEPRECATED???
<span class='line'>1637</span>  * @private
<span class='line'>1638</span>  * @param {XMLNode} xd
<span class='line'>1639</span>  */</span><span class="WHIT">
<span class='line'>1640</span> </span><span class="NAME">nitobi.data.DataTable.prototype.mergeData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1641</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1642</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.xmlDoc.xml</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1643</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1644</span> </span><span class="WHIT">		</span><span class="NAME">this.initializeXml</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1645</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1646</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1647</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1648</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xpath</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">p</span><span class="PUNC">+</span><span class="STRN">"datasource[@id = '"</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">"']/"</span><span class="PUNC">+</span><span class="NAME">p</span><span class="PUNC">+</span><span class="STRN">"data"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1649</span> 
<span class='line'>1650</span> </span><span class="WHIT">	</span><span class="COMM">//	We need to merge the new data into our dataset because we are in caching mode ...</span><span class="WHIT">
<span class='line'>1651</span> </span><span class="WHIT">	</span><span class="COMM">//	Need to be able to generate some XSL based on the returned data ...</span><span class="WHIT">
<span class='line'>1652</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectNodes</span><span class="PUNC">(</span><span class="NAME">xpath</span><span class="PUNC">+</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">p</span><span class="PUNC">+</span><span class="STRN">"e"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1653</span> 
<span class='line'>1654</span> </span><span class="WHIT">	</span><span class="COMM">//	this shoudl be abstracted into something like this.getDataSourceNode so that we can override it easily...</span><span class="WHIT">
<span class='line'>1655</span> </span><span class="WHIT">	</span><span class="COMM">//	or it should use an object like a data source connector/resolver to do that!!!</span><span class="WHIT">
<span class='line'>1656</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">oldData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="NAME">xpath</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1657</span> 
<span class='line'>1658</span> </span><span class="WHIT">	</span><span class="COMM">//	TODO: somehow, despite having our request cache, we are getting duplicate xi values...</span><span class="WHIT">
<span class='line'>1659</span> </span><span class="WHIT">	</span><span class="COMM">//	To fix this i moved the request cache into the viewport itself ...</span><span class="WHIT">
<span class='line'>1660</span> 
<span class='line'>1661</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">len</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newData.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1662</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">len</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1663</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1664</span> </span><span class="WHIT">		</span><span class="COMM">//	importNode???? namespaces????</span><span class="WHIT">
<span class='line'>1665</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'datasource[@id=\''</span><span class="PUNC">+</span><span class="NAME">this.id</span><span class="PUNC">+</span><span class="STRN">'\']/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data/'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'e[@xi=\''</span><span class="PUNC">+</span><span class="NAME">newData</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">'xi'</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="STRN">'\']'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1666</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1667</span> </span><span class="WHIT">			</span><span class="KEYW">continue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1668</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1669</span> </span><span class="WHIT">		</span><span class="NAME">oldData.appendChild</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">oldData.ownerDocument</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newData</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1670</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1671</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1672</span> 
<span class='line'>1673</span> </span><span class="COMM">/**
<span class='line'>1674</span>  * @private
<span class='line'>1675</span>  */</span><span class="WHIT">
<span class='line'>1676</span> </span><span class="NAME">nitobi.data.DataTable.prototype.assignRowIds</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1677</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1678</span> </span><span class="WHIT">	</span><span class="NAME">nitobi.data.addXidXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'guid'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.component.getUniqueId</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1679</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.addXidXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1680</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">doc</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1681</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1682</span> 
<span class='line'>1683</span> </span><span class="COMM">/**
<span class='line'>1684</span>  * @private
<span class='line'>1685</span>  */</span><span class="WHIT">
<span class='line'>1686</span> </span><span class="NAME">nitobi.data.DataTable.prototype.inferDataVersion</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1687</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1688</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"/root"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">2.8</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1689</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NUMB">3.0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1690</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1691</span> 
<span class='line'>1692</span> </span><span class="COMM">/**
<span class='line'>1693</span>  * @private
<span class='line'>1694</span>  */</span><span class="WHIT">
<span class='line'>1695</span> </span><span class="NAME">nitobi.data.DataTable.prototype.parseResponse</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1696</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1697</span> </span><span class="WHIT">	</span><span class="COMM">//	First check the version that we are working with</span><span class="WHIT">
<span class='line'>1698</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.version</span><span class="PUNC">==</span><span class="NUMB">2.8</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1699</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1700</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.parseLegacyResponse</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1701</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1702</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1703</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1704</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.parseStructuredResponse</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1705</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1706</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1707</span> </span><span class="COMM">/**
<span class='line'>1708</span>  * Parses a response from an Grid V2.8 server handler.
<span class='line'>1709</span>  * @private
<span class='line'>1710</span>  */</span><span class="WHIT">
<span class='line'>1711</span> </span><span class="NAME">nitobi.data.DataTable.prototype.parseLegacyResponse</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1712</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1713</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">startXi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"paging"</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.startXi</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1714</span> </span><span class="WHIT">	</span><span class="NAME">nitobi.data.dataTranslatorXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'start'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">startXi</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1715</span> </span><span class="WHIT">	</span><span class="NAME">nitobi.data.dataTranslatorXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'id'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1716</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fieldsNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"/root"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"fields"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1717</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fields</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fieldsNode.split</span><span class="PUNC">(</span><span class="STRN">"|"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1718</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fields.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1719</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xkField</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">></span><span class="NUMB">25</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NAME">Math.floor</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">/</span><span class="NUMB">26</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="NUMB">96</span><span class="PUNC">)</span><span class="PUNC">:</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">+</span><span class="PUNC">(</span><span class="NAME">String.fromCharCode</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">%</span><span class="NUMB">26</span><span class="PUNC">+</span><span class="NUMB">97</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1720</span> </span><span class="WHIT">	</span><span class="NAME">nitobi.data.dataTranslatorXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'xkField'</span><span class="PUNC">,</span><span class="NAME">xkField</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="COMM">// last column of table is the key field</span><span class="WHIT">
<span class='line'>1721</span> </span><span class="WHIT">	</span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToXml</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.dataTranslatorXslProc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1722</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">xd</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1723</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1724</span> 
<span class='line'>1725</span> </span><span class="COMM">/**
<span class='line'>1726</span>  * @private
<span class='line'>1727</span>  */</span><span class="WHIT">
<span class='line'>1728</span> </span><span class="NAME">nitobi.data.DataTable.prototype.parseStructuredResponse</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1729</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1730</span> </span><span class="WHIT">	</span><span class="COMM">// Drop all other datasources.</span><span class="WHIT">
<span class='line'>1731</span> </span><span class="WHIT">	</span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'&lt;ntb:grid xmlns:ntb="http://www.nitobi.com">&lt;ntb:datasources>'</span><span class="PUNC">+</span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasource[@id='"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"']"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">xml</span><span class="PUNC">+</span><span class="STRN">'&lt;/ntb:datasources>&lt;/ntb:grid>'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1732</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">firstRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xd.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">"//"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"datasource[@id='"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"']/"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"data/"</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">"e"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1733</span> </span><span class="WHIT">	</span><span class="COMM">// So far, there is a dependency on xi from the server.</span><span class="WHIT">
<span class='line'>1734</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">startXi</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"paging"</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">getCompleteEvtArgs.startXi</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1735</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1736</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1737</span> </span><span class="WHIT">		</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">Boolean</span><span class="PUNC">(</span><span class="NAME">firstRow.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">"No xi was returned in the data from the server. Server must return xi's in the new format."</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1738</span> </span><span class="WHIT">		</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">startXi</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="STRN">"startXI is incorrect."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1739</span> 
<span class='line'>1740</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: Refactor into a method.</span><span class="WHIT">
<span class='line'>1741</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">firstRow.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">startXi</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1742</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1743</span> </span><span class="WHIT">			</span><span class="NAME">nitobi.data.adjustXiXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"startingIndex"</span><span class="PUNC">,</span><span class="STRN">"0"</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1744</span> </span><span class="WHIT">			</span><span class="NAME">nitobi.data.adjustXiXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">"adjustment"</span><span class="PUNC">,</span><span class="NAME">startXi</span><span class="PUNC">,</span><span class="STRN">""</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1745</span> </span><span class="WHIT">			</span><span class="NAME">xd</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">xd</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.adjustXiXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1746</span> </span><span class="WHIT">			</span><span class="WHIT">
<span class='line'>1747</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1748</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1749</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">xd</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1750</span> 
<span class='line'>1751</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1752</span> 
<span class='line'>1753</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1754</span> </span><span class="COMM">// PAGING</span><span class="WHIT">
<span class='line'>1755</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1756</span> </span><span class="COMM">/**
<span class='line'>1757</span>  * LARGE NOTE: I don't think get should ignore the call if it thinks it already has it. This gets the rows
<span class='line'>1758</span>  * regardless of cache. This allows us to check for the return error before we flush our data.
<span class='line'>1759</span>  * There should be a better way to force the get function to get the page you want. TODO: Eliminate forceGet
<span class='line'>1760</span>  * @private
<span class='line'>1761</span>  */</span><span class="WHIT">
<span class='line'>1762</span> </span><span class="NAME">nitobi.data.DataTable.prototype.forceGet</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">successCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1763</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1764</span> </span><span class="WHIT">		</span><span class="NAME">this.errorCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1765</span> </span><span class="WHIT">		</span><span class="NAME">this.successCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">successCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1766</span> </span><span class="WHIT">		</span><span class="NAME">this.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1767</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getGetHandler</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1768</span> </span><span class="WHIT">		</span><span class="COMM">//	TODO: this should be a handlerResolver object or something ...</span><span class="WHIT">
<span class='line'>1769</span> </span><span class="WHIT">		</span><span class="PUNC">(</span><span class="NAME">getHandler.indexOf</span><span class="PUNC">(</span><span class="STRN">'?'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'?'</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT">  </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1770</span> </span><span class="WHIT">		</span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'StartRecordIndex=0&start=0&PageSize='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&SortColumn='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.sortColumn</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&SortDirection='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.sortDir</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&TableId='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.id</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&uid='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Date</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getTime</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1771</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ajaxCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.reserve</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1772</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1773</span> </span><span class="WHIT">		</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">Boolean</span><span class="PUNC">(</span><span class="NAME">ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">"The datasource is serving too many connections. Please try again later. # current connections: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.inUse.length</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1774</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.handler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1775</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.responseType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1776</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1777</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.completeCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="NAME">this.getComplete</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1778</span> </span><span class="WHIT">		</span><span class="COMM">//ajaxCallback.onGetComplete.subscribeOnce(this.getComplete, this);</span><span class="WHIT">
<span class='line'>1779</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.params</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.GetCompleteEventArgs</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ajaxCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1780</span> </span><span class="WHIT">		</span><span class="NAME">ajaxCallback.get</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1781</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1782</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1783</span> 
<span class='line'>1784</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getPage</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">successCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1785</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1786</span> </span><span class="WHIT">	</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">this.getHandler.indexOf</span><span class="PUNC">(</span><span class="STRN">"GridId"</span><span class="PUNC">)</span><span class="PUNC">!=</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="STRN">"The gethandler has not gridId specified on it."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1787</span> </span><span class="COMM">//	this.forceGet(start, pageSize, context, callback, errorCallback, successCallback)</span><span class="WHIT">
<span class='line'>1788</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1789</span> 
<span class='line'>1790</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataCache.gaps</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1791</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numCacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cacheGaps.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1792</span> 
<span class='line'>1793</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">numCacheGaps</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1794</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1795</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">requestGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.requestCache.gaps</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">lastRow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1796</span> 
<span class='line'>1797</span> </span><span class="WHIT">		</span><span class="COMM">//	There is a request outstanding for this data already ...</span><span class="WHIT">
<span class='line'>1798</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">requestGaps.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1799</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1800</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">funcref</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1801</span> </span><span class="WHIT">			</span><span class="NAME">this.requestQueue.push</span><span class="PUNC">(</span><span class="NAME">funcref</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1802</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1803</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1804</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1805</span> </span><span class="WHIT">		</span><span class="NAME">this.getFromServer</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1806</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1807</span> </span><span class="WHIT">	</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1808</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1809</span> </span><span class="WHIT">		</span><span class="NAME">this.getFromCache</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1810</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1811</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1812</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1813</span> 
<span class='line'>1814</span> </span><span class="COMM">/**
<span class='line'>1815</span>  * General request for data.
<span class='line'>1816</span>  * @param {int} start
<span class='line'>1817</span>  * @param {int} pageSize
<span class='line'>1818</span>  * @param {object} context
<span class='line'>1819</span>  * @param {function} callback
<span class='line'>1820</span>  * @param {function} errorCallback
<span class='line'>1821</span>  * @public
<span class='line'>1822</span>  */</span><span class="WHIT">
<span class='line'>1823</span> </span><span class="NAME">nitobi.data.DataTable.prototype.get</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1824</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1825</span> </span><span class="WHIT">		</span><span class="NAME">this.errorCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1826</span> 
<span class='line'>1827</span> </span><span class="WHIT">		</span><span class="COMM">//	TODO: Why is this section only for the default datasource?</span><span class="WHIT">
<span class='line'>1828</span> </span><span class="WHIT">		</span><span class="COMM">//  This is temporary. we needed to simplify the gethandlers for other data sources.</span><span class="WHIT">
<span class='line'>1829</span> </span><span class="WHIT">		</span><span class="COMM">//  Didn't want the startrecordindex, pagesize etc. getting in there. </span><span class="WHIT">
<span class='line'>1830</span> </span><span class="COMM">/*
<span class='line'>1831</span> 		if (this.id == "_default")
<span class='line'>1832</span> 		{
<span class='line'>1833</span> 			return this.getCached(start, pageSize, context, callback, errorCallback)
<span class='line'>1834</span> //			this.getPage(start, pageSize, context, callback, errorCallback, successCallback)
<span class='line'>1835</span> //			this.getSync(start, pageSize)
<span class='line'>1836</span> 		} else {
<span class='line'>1837</span> 			return this.getTable(context, callback, errorCallback)
<span class='line'>1838</span> 		}
<span class='line'>1839</span> */</span><span class="WHIT">
<span class='line'>1840</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1841</span> 
<span class='line'>1842</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"caching"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1843</span> </span><span class="WHIT">			</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getCached</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1844</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1845</span> </span><span class="COMM">//		if (this.mode=="static") {</span><span class="WHIT">
<span class='line'>1846</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: get the modes all sorted.</span><span class="WHIT">
<span class='line'>1847</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"local"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"static"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1848</span> </span><span class="WHIT">			</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getTable</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1849</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1850</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">==</span><span class="STRN">"paging"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1851</span> </span><span class="WHIT">			</span><span class="NAME">result</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getPage</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1852</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1853</span> 
<span class='line'>1854</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">result</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1855</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1856</span> 
<span class='line'>1857</span> 
<span class='line'>1858</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1859</span> </span><span class="COMM">// CACHING</span><span class="WHIT">
<span class='line'>1860</span> </span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1861</span> </span><span class="COMM">/**
<span class='line'>1862</span>  * Determines if the range specified exists in the data on the client.
<span class='line'>1863</span>  * @param {int} start Start index of range.
<span class='line'>1864</span>  * @param {int} pageSize Number of records in range.
<span class='line'>1865</span>  * @public
<span class='line'>1866</span>  */</span><span class="WHIT">
<span class='line'>1867</span> </span><span class="NAME">nitobi.data.DataTable.prototype.inCache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">pageSize</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1868</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1869</span> </span><span class="WHIT">	</span><span class="COMM">// TODO: this should not be here since local data should be inCache always...</span><span class="WHIT">
<span class='line'>1870</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'local'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1871</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1872</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1873</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1874</span> 
<span class='line'>1875</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">firstRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1876</span> 
<span class='line'>1877</span> </span><span class="WHIT">	</span><span class="COMM">// If we know the last row and are checking the cache past the end of</span><span class="WHIT">
<span class='line'>1878</span> </span><span class="WHIT">	</span><span class="COMM">// the data there is no way the data will be in cache so reduce the lastRow</span><span class="WHIT">
<span class='line'>1879</span> </span><span class="WHIT">	</span><span class="COMM">// to the lastKnownRow value instead.</span><span class="WHIT">
<span class='line'>1880</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lastKnownRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getRemoteRowCount</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1881</span> 
<span class='line'>1882</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.getRowCountKnown</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">lastKnownRow</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1883</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1884</span> </span><span class="WHIT">		</span><span class="NAME">lastRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">lastKnownRow</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1885</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1886</span> 
<span class='line'>1887</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataCache.gaps</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1888</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numCacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cacheGaps.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1889</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">numCacheGaps</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1890</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1891</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1892</span> </span><span class="COMM">/**
<span class='line'>1893</span>  * Returns the blocks of data that are already cached on the client.
<span class='line'>1894</span>  * @param {int} start Start index of range.
<span class='line'>1895</span>  * @param {int} pageSize Number of records in range.
<span class='line'>1896</span>  * @public
<span class='line'>1897</span>  */</span><span class="WHIT">
<span class='line'>1898</span> </span><span class="NAME">nitobi.data.DataTable.prototype.cachedRanges</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="NAME">lastRow</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1899</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1900</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.dataCache.ranges</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1901</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1902</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1903</span> </span><span class="COMM">/**
<span class='line'>1904</span>  * Request for page of data into a cached data table
<span class='line'>1905</span>  * @param {int} start
<span class='line'>1906</span>  * @param {int} pageSize
<span class='line'>1907</span>  * @param {int} context
<span class='line'>1908</span>  * @param {int} callback
<span class='line'>1909</span>  * @param {int} errorCallback
<span class='line'>1910</span>  * @param {int} successCallback
<span class='line'>1911</span>  * @public
<span class='line'>1912</span>  */</span><span class="WHIT">
<span class='line'>1913</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getCached</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">successCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1914</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1915</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1916</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1917</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.getFromServer</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1918</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1919</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>1920</span> </span><span class="WHIT">		</span><span class="COMM">//	first this is to check what part of the data we don't already have ...</span><span class="WHIT">
<span class='line'>1921</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">firstRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1922</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataCache.gaps</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1923</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">numCacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cacheGaps.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1924</span> </span><span class="WHIT">		</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">numCacheGaps</span><span class="PUNC">==</span><span class="NAME">cacheGaps.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"numCacheGaps != gaps.length despite setting it so. Concurrency problem has arisen."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1925</span> 
<span class='line'>1926</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="PUNC">!=</span><span class="STRN">"unbound"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">numCacheGaps</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1927</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1928</span> </span><span class="WHIT">			</span><span class="COMM">// There are certain situations - like when user scrolls to the bottom - that we </span><span class="WHIT">
<span class='line'>1929</span> </span><span class="WHIT">			</span><span class="COMM">// do get multiple cacheGaps. In those cases LiveScrolling stops working if we loop through each.</span><span class="WHIT">
<span class='line'>1930</span> </span><span class="COMM">//			for (var i=0; i&lt;numCacheGaps; i++)</span><span class="WHIT">
<span class='line'>1931</span> </span><span class="COMM">//			{</span><span class="WHIT">
<span class='line'>1932</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">low</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NAME">numCacheGaps</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">low</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1933</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">high</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NAME">numCacheGaps</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">high</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1934</span> 
<span class='line'>1935</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">requestGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.requestCache.gaps</span><span class="PUNC">(</span><span class="NAME">low</span><span class="PUNC">,</span><span class="NAME">high</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1936</span> 
<span class='line'>1937</span> </span><span class="WHIT">				</span><span class="COMM">//	There is a request outstanding for this data already ...</span><span class="WHIT">
<span class='line'>1938</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">requestGaps.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1939</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1940</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">funcref</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.get</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">arguments</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1941</span> </span><span class="WHIT">					</span><span class="COMM">//window.setTimeout(funcref, 100);</span><span class="WHIT">
<span class='line'>1942</span> </span><span class="WHIT">					</span><span class="NAME">this.requestQueue.push</span><span class="PUNC">(</span><span class="NAME">funcref</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1943</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1944</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1945</span> </span><span class="COMM">//				else</span><span class="WHIT">
<span class='line'>1946</span> </span><span class="COMM">//				{</span><span class="WHIT">
<span class='line'>1947</span> </span><span class="COMM">//					this.requestCache.insert(low,high);</span><span class="WHIT">
<span class='line'>1948</span> </span><span class="COMM">//				}</span><span class="WHIT">
<span class='line'>1949</span> 
<span class='line'>1950</span> </span><span class="COMM">/*
<span class='line'>1951</span> 				var getHandler = this.getHandler;
<span class='line'>1952</span> 				//	TODO: this should be a handlerResolver object or something ...
<span class='line'>1953</span> 				(getHandler.indexOf('?') == -1) ? getHandler += '?' :  getHandler += '&';
<span class='line'>1954</span> 				getHandler += 'StartRecordIndex=' + low + '&start=' + low + '&PageSize=' + (high - low + 1) + '&SortColumn=' + (this.sortColumn || '') + '&SortDirection=' + this.sortDir + '&TableId=' + this.id + '&uid=' + (new Date().getTime());
<span class='line'>1955</span> */</span><span class="WHIT">
<span class='line'>1956</span> </span><span class="WHIT">				</span><span class="COMM">// Return the result from the getRequest as it may be synchronous if no callback is specified.</span><span class="WHIT">
<span class='line'>1957</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.getFromServer</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">low</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">high</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1958</span> </span><span class="COMM">//			}</span><span class="WHIT">
<span class='line'>1959</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1960</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>1961</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1962</span> </span><span class="WHIT">			</span><span class="NAME">this.getFromCache</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1963</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1964</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1965</span> 
<span class='line'>1966</span> 
<span class='line'>1967</span> </span><span class="COMM">/**
<span class='line'>1968</span>  * Gets data from the server-side data via Eba.Calback.
<span class='line'>1969</span>  */</span><span class="WHIT">
<span class='line'>1970</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getFromServer</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">low</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">high</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1971</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1972</span> </span><span class="WHIT">	</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">this.getHandler</span><span class="PUNC">!=</span><span class="KEYW">null</span><span class="PUNC">&&</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">this.getHandler</span><span class="PUNC">)</span><span class="PUNC">!=</span><span class="STRN">"undefined"</span><span class="PUNC">,</span><span class="STRN">"getHandler not defined in table eba.datasource"</span><span class="PUNC">,</span><span class="NAME">EBA_THROW</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1973</span> 
<span class='line'>1974</span> </span><span class="WHIT">	</span><span class="NAME">this.requestCache.insert</span><span class="PUNC">(</span><span class="NAME">low</span><span class="PUNC">,</span><span class="NAME">high</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1975</span> 
<span class='line'>1976</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">lastRow</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">high</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">low</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1977</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">strPageSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="STRN">""</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1978</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getGetHandler</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1979</span> </span><span class="WHIT">	</span><span class="COMM">//	TODO: this should be a handlerResolver object or something ...</span><span class="WHIT">
<span class='line'>1980</span> </span><span class="WHIT">	</span><span class="PUNC">(</span><span class="NAME">getHandler.indexOf</span><span class="PUNC">(</span><span class="STRN">'?'</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'?'</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT">  </span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'&'</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1981</span> </span><span class="WHIT">	</span><span class="NAME">getHandler</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">'StartRecordIndex='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">low</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&start='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">low</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&PageSize='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">strPageSize</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&SortColumn='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.sortColumn</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&SortDirection='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.sortDir</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">'&uid='</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Date</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getTime</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1982</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ajaxCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.reserve</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1983</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1984</span> </span><span class="WHIT">	</span><span class="NAME">ntbAssert</span><span class="PUNC">(</span><span class="NAME">Boolean</span><span class="PUNC">(</span><span class="NAME">ajaxCallback</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">"The datasource is serving too many connections. Please try again later. # current connections: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">this.ajaxCallbackPool.inUse.length</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1985</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.handler</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">getHandler</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1986</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.responseType</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1987</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.context</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1988</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.completeCallback</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="NAME">this.getComplete</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1989</span> </span><span class="WHIT">	</span><span class="COMM">//ajaxCallback.onGetComplete.subscribeOnce(this.getComplete, this);</span><span class="WHIT">
<span class='line'>1990</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.async</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.async</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1991</span> </span><span class="WHIT">	</span><span class="NAME">ajaxCallback.params</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.GetCompleteEventArgs</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">low</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">ajaxCallback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1992</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>1993</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">ajaxCallback.get</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1994</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1995</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>1996</span> 	 * Gets data from the cached (client-side) data
<span class='line'>1997</span> 	 */</span><span class="WHIT">
<span class='line'>1998</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getFromCache</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">errorCallback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1999</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2000</span> 
<span class='line'>2001</span> </span><span class="WHIT">	</span><span class="COMM">//	The only reason that we would be here is if the data is already in the DataSource - that is a good thing!</span><span class="WHIT">
<span class='line'>2002</span> </span><span class="WHIT">		</span><span class="COMM">//	first this is to check what part of the data we don't already have ...</span><span class="WHIT">
<span class='line'>2003</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">firstRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">pageSize</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2004</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">></span><span class="NUMB">0</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">></span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>2005</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2006</span> </span><span class="WHIT">		</span><span class="COMM">// If this was an asynchronous request then call the callback</span><span class="WHIT">
<span class='line'>2007</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">'function'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2008</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2009</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">evtArgs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">nitobi.data.GetCompleteEventArgs</span><span class="PUNC">(</span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">firstRow</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastRow</span><span class="PUNC">-</span><span class="NAME">firstRow</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2010</span> </span><span class="WHIT">			</span><span class="NAME">evtArgs.callback.call</span><span class="PUNC">(</span><span class="NAME">evtArgs.context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">evtArgs</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2011</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2012</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2013</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2014</span> </span><span class="WHIT">	</span><span class="COMM">/*
<span class='line'>2015</span> 	 * Merges a properly formatted XMLDocument into the datasource.
<span class='line'>2016</span> 	 * @param {XMLDocument} xmlDoc The XMLDocument to merge with the datasource.  The document will include row indexes for each element.
<span class='line'>2017</span> 	 */</span><span class="WHIT">
<span class='line'>2018</span> </span><span class="NAME">nitobi.data.DataTable.prototype.mergeFromXml</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2019</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2020</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">startRowIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">xmlDoc.documentElement.firstChild.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT">
<span class='line'>2021</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Number</span><span class="PUNC">(</span><span class="NAME">xmlDoc.documentElement.lastChild.getAttribute</span><span class="PUNC">(</span><span class="STRN">"xi"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2022</span> 
<span class='line'>2023</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.dataCache.gaps</span><span class="PUNC">(</span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2024</span> 
<span class='line'>2025</span> </span><span class="WHIT">		</span><span class="COMM">// If we are working in local mode there is no going back to the server so just</span><span class="WHIT">
<span class='line'>2026</span> </span><span class="WHIT">		</span><span class="COMM">// insert the range into the dataCache</span><span class="WHIT">
<span class='line'>2027</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">this.mode</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"local"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">cacheGaps.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2028</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2029</span> </span><span class="COMM">//			this.beginBatchInsert();</span><span class="WHIT">
<span class='line'>2030</span> </span><span class="COMM">//			for (var rowIndex=cacheGaps[0].low; rowIndex&lt;=cacheGaps[0].high; rowIndex ++)</span><span class="WHIT">
<span class='line'>2031</span> </span><span class="COMM">//			{</span><span class="WHIT">
<span class='line'>2032</span> </span><span class="COMM">//				this.createRecord(null, rowIndex);</span><span class="WHIT">
<span class='line'>2033</span> </span><span class="COMM">//			}</span><span class="WHIT">
<span class='line'>2034</span> </span><span class="WHIT">			</span><span class="NAME">this.dataCache.insert</span><span class="PUNC">(</span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">low</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">high</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2035</span> </span><span class="WHIT">			</span><span class="NAME">this.mergeFromXmlGetComplete</span><span class="PUNC">(</span><span class="NAME">xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2036</span> </span><span class="WHIT">			</span><span class="NAME">this.batchInsertRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">high</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">low</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2037</span> </span><span class="WHIT">			</span><span class="NAME">this.commitBatchInsert</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2038</span> </span><span class="WHIT">			</span><span class="KEYW">return</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2039</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2040</span> 
<span class='line'>2041</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cacheGaps.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2042</span> </span><span class="WHIT">			</span><span class="COMM">// There are no gaps in the data do just merge it</span><span class="WHIT">
<span class='line'>2043</span> </span><span class="WHIT">			</span><span class="NAME">this.mergeFromXmlGetComplete</span><span class="PUNC">(</span><span class="NAME">xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2044</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">cacheGaps.length</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2045</span> </span><span class="WHIT">			</span><span class="COMM">// There is a gap</span><span class="WHIT">
<span class='line'>2046</span> </span><span class="WHIT">			</span><span class="NAME">this.get</span><span class="PUNC">(</span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">low</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">high</span><span class="PUNC">-</span><span class="NAME">cacheGaps</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">low</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.mergeFromXmlGetComplete</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2047</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>2048</span> </span><span class="WHIT">			</span><span class="COMM">// There is no data in the paste range</span><span class="WHIT">
<span class='line'>2049</span> </span><span class="WHIT">			</span><span class="NAME">this.forceGet</span><span class="PUNC">(</span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.mergeFromXmlGetComplete</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2050</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2051</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>2052</span> 	 * @private
<span class='line'>2053</span> 	 */</span><span class="WHIT">
<span class='line'>2054</span> </span><span class="NAME">nitobi.data.DataTable.prototype.mergeFromXmlGetComplete</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">callback</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">endRowIndex</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2055</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2056</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newDataNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createElement</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"newdata"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2057</span> </span><span class="WHIT">		</span><span class="NAME">newDataNode.appendChild</span><span class="PUNC">(</span><span class="NAME">xmlDoc.documentElement.cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2058</span> 
<span class='line'>2059</span> </span><span class="WHIT">		</span><span class="NAME">this.xmlDoc.documentElement.appendChild</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newDataNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2060</span> 
<span class='line'>2061</span> </span><span class="WHIT">		</span><span class="COMM">//	set the parameters for doing the merge of the data</span><span class="WHIT">
<span class='line'>2062</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.mergeEbaXmlXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'startRowIndex'</span><span class="PUNC">,</span><span class="NAME">startRowIndex</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2063</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.mergeEbaXmlXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'endRowIndex'</span><span class="PUNC">,</span><span class="NAME">endRowIndex</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2064</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.mergeEbaXmlXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'guid'</span><span class="PUNC">,</span><span class="NAME">nitobi.component.getUniqueId</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2065</span> 
<span class='line'>2066</span> </span><span class="WHIT">		</span><span class="NAME">this.xmlDoc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.mergeEbaXmlXslProc</span><span class="PUNC">,</span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2067</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>2068</span> </span><span class="WHIT">		</span><span class="NAME">newDataNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createElement</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"newdata"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2069</span> 
<span class='line'>2070</span> </span><span class="WHIT">		</span><span class="NAME">this.log.documentElement.appendChild</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newDataNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2071</span> 
<span class='line'>2072</span> </span><span class="WHIT">		</span><span class="NAME">newDataNode.appendChild</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'newdata'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">firstChild.cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2073</span> 
<span class='line'>2074</span> </span><span class="WHIT">		</span><span class="NAME">this.log</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.loadXml</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.mergeEbaXmlToLogXslProc</span><span class="PUNC">,</span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2075</span> 
<span class='line'>2076</span> </span><span class="WHIT">		</span><span class="NAME">this.xmlDoc.documentElement.removeChild</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'newdata'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2077</span> </span><span class="WHIT">		</span><span class="NAME">this.log.documentElement.removeChild</span><span class="PUNC">(</span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'newdata'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2078</span> 
<span class='line'>2079</span> </span><span class="WHIT">		</span><span class="NAME">callback.call</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2080</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2081</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>2082</span> </span><span class="NAME">nitobi.data.DataTable.prototype.fillColumn</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">columnName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2083</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2084</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>2085</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.fillColumnXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'column'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.fieldMap</span><span class="PUNC">[</span><span class="NAME">columnName</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">substring</span><span class="PUNC">(</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2086</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.fillColumnXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'value'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">value</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2087</span> </span><span class="WHIT">		</span><span class="NAME">this.xmlDoc.loadXML</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.fillColumnXslProc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2088</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>2089</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">startTime</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Date</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">getTime</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2090</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newDataNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nitobi.xml.createElement</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"newdata"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2091</span> 
<span class='line'>2092</span> </span><span class="WHIT">		</span><span class="NAME">this.log.documentElement.appendChild</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.importNode</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">newDataNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2093</span> </span><span class="WHIT">		</span><span class="WHIT">
<span class='line'>2094</span> </span><span class="WHIT">		</span><span class="NAME">newDataNode.appendChild</span><span class="PUNC">(</span><span class="NAME">this.xmlDoc.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'data'</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">cloneNode</span><span class="PUNC">(</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2095</span> 
<span class='line'>2096</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.mergeEbaXmlToLogXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'defaultAction'</span><span class="PUNC">,</span><span class="STRN">'u'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2097</span> </span><span class="WHIT">		</span><span class="NAME">this.log.loadXML</span><span class="PUNC">(</span><span class="NAME">nitobi.xml.transformToString</span><span class="PUNC">(</span><span class="NAME">this.log</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nitobi.data.mergeEbaXmlToLogXslProc</span><span class="PUNC">,</span><span class="STRN">"xml"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2098</span> </span><span class="WHIT">		</span><span class="NAME">nitobi.data.mergeEbaXmlToLogXslProc.addParameter</span><span class="PUNC">(</span><span class="STRN">'defaultAction'</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2099</span> 
<span class='line'>2100</span> </span><span class="WHIT">		</span><span class="NAME">this.log.documentElement.removeChild</span><span class="PUNC">(</span><span class="NAME">this.log.selectSingleNode</span><span class="PUNC">(</span><span class="STRN">'//'</span><span class="PUNC">+</span><span class="NAME">nitobi.xml.nsPrefix</span><span class="PUNC">+</span><span class="STRN">'newdata'</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2101</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2102</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>2103</span> </span><span class="COMM">/**
<span class='line'>2104</span>  * Returns the total number of rows in the remote datasource that this DataTable corresponds to.
<span class='line'>2105</span>  * @type Number
<span class='line'>2106</span>  */</span><span class="WHIT">
<span class='line'>2107</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getTotalRowCount</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2108</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2109</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.totalRowCount</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2110</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2111</span> 
<span class='line'>2112</span> </span><span class="NAME">nitobi.data.DataTable.prototype.setHandlerError</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">error</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2113</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2114</span> </span><span class="WHIT">		</span><span class="NAME">this.handlerError</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">error</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2115</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2116</span> </span><span class="NAME">nitobi.data.DataTable.prototype.getHandlerError</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>2117</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2118</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.handlerError</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2119</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2120</span> </span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>2121</span> </span><span class="NAME">nitobi.data.DataTable.prototype.dispose</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">  </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2122</span> 
<span class='line'>2123</span> </span><span class="WHIT">		</span><span class="NAME">this.sortXslProc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2124</span> 
<span class='line'>2125</span> </span><span class="WHIT">		</span><span class="NAME">this.requestQueue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2126</span> </span><span class="WHIT">		</span><span class="NAME">this.fieldMap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2127</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2128</span> 
<span class='line'>2129</span> </span><span class="COMM">/**
<span class='line'>2130</span>  * @private
<span class='line'>2131</span>  */</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>2132</span> </span><span class="NAME">nitobi.data.DataTable.prototype.fire</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">,</span><span class="NAME">args</span><span class="PUNC">)</span><span class="WHIT">  </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2133</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">nitobi.event.notify</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">+</span><span class="NAME">this.uid</span><span class="PUNC">,</span><span class="NAME">args</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2134</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>2135</span> </span><span class="COMM">/**
<span class='line'>2136</span>  * @private
<span class='line'>2137</span>  */</span><span class="WHIT">	</span><span class="WHIT">
<span class='line'>2138</span> </span><span class="NAME">nitobi.data.DataTable.prototype.subscribe</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">,</span><span class="NAME">func</span><span class="PUNC">,</span><span class="NAME">context</span><span class="PUNC">)</span><span class="WHIT">  </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>2139</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">typeof</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">)</span><span class="PUNC">==</span><span class="STRN">"undefined"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">context</span><span class="PUNC">=</span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2140</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">nitobi.event.subscribe</span><span class="PUNC">(</span><span class="NAME">evt</span><span class="PUNC">+</span><span class="NAME">this.uid</span><span class="PUNC">,</span><span class="NAME">nitobi.lang.close</span><span class="PUNC">(</span><span class="NAME">context</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">func</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>2141</span> </span><span class="PUNC">}</span></pre></body></html>